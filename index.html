<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Commercial Pro</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
    .container { max-width: 1400px; margin: 0 auto; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
    h1 { color: white; font-size: 2.5rem; font-weight: 300; }
    .month-selector { display: flex; align-items: center; background: rgba(255, 255, 255, 0.1); border-radius: 15px; padding: 10px; backdrop-filter: blur(10px); }
    .month-btn { background: transparent; border: none; color: white; font-size: 24px; cursor: pointer; padding: 10px; border-radius: 8px; transition: all 0.3s; }
    .month-btn:hover { background: rgba(255, 255, 255, 0.1); transform: scale(1.1); }
    .current-month { color: white; font-size: 18px; font-weight: 500; margin: 0 20px; min-width: 150px; text-align: center; }
    .tabs { display: flex; background: rgba(255, 255, 255, 0.1); border-radius: 15px; padding: 5px; margin-bottom: 30px; backdrop-filter: blur(10px); overflow-x: auto; }
    .tab { flex: 1; padding: 15px; text-align: center; background: transparent; border: none; color: rgba(255,255,255,0.7); cursor: pointer; border-radius: 10px; transition: all 0.3s; font-size: 16px; white-space: nowrap; }
    .tab.active { background: rgba(255, 255, 255, 0.2); color: white; transform: translateY(-2px); box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .overview-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .overview-card { background: rgba(255,255,255,0.95); border-radius: 15px; padding: 25px; text-align: center; box-shadow: 0 8px 32px rgba(0,0,0,0.1); backdrop-filter: blur(10px); position: relative; overflow: hidden; }
    .overview-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(45deg, #667eea, #764ba2); }
    .overview-card h3 { color: #4a5568; font-size: 14px; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
    .overview-card .value { font-size: 2rem; font-weight: bold; margin-bottom: 5px; }
    .overview-card .trend { font-size: 12px; display: flex; align-items: center; justify-content: center; gap: 5px; }
    .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .card { background: rgba(255,255,255,0.95); border-radius: 15px; padding: 25px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); backdrop-filter: blur(10px); transition: transform 0.3s; position: relative; z-index: 1; }
    .card:hover { transform: translateY(-5px); }
    .chart-container { background: rgba(255,255,255,0.95); border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); }
    .chart { display: flex; align-items: end; gap: 15px; height: 200px; padding: 20px 0; }
    .bar-group { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 10px; }
    .bar { width: 100%; max-width: 60px; background: linear-gradient(to top, #667eea, #764ba2); border-radius: 4px 4px 0 0; position: relative; transition: all 0.3s; cursor: pointer; }
    .bar:hover { transform: scaleY(1.05); box-shadow: 0 4px 20px rgba(102,126,234,0.3); }
    .bar-value { position: absolute; top: -25px; left: 50%; transform: translateX(-50%); font-size: 12px; font-weight: bold; color: #4a5568; white-space: nowrap; }
    .bar-label { font-size: 12px; color: #4a5568; text-align: center; font-weight: 500; }
    .metric { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #e2e8f0; }
    .metric:last-child { border-bottom: none; }
    .metric-value { font-weight: bold; font-size: 1.1rem; }
    .positive { color: #38a169; } .negative { color: #e53e3e; } .neutral { color: #4a5568; }
    .progress-bar { width: 100%; height: 10px; background: #e2e8f0; border-radius: 5px; margin-top: 10px; overflow: hidden; }
    .progress-fill { height: 100%; border-radius: 5px; transition: all 0.8s ease; background: linear-gradient(45deg, #38a169, #48bb78); }
    .input-group { margin-bottom: 20px; }
    .input-group label { display: block; margin-bottom: 8px; color: #4a5568; font-weight: 500; }
    .input-group input, .input-group select { width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; transition: border-color 0.3s; }
    .input-group input:focus, .input-group select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }
    .btn { background: linear-gradient(45deg, #667eea, #764ba2); color: white; border: none; padding: 14px 28px; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: 500; margin: 5px; transition: all 0.3s; box-shadow: 0 4px 15px rgba(102,126,234,0.3); position: relative; z-index: 10; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(102,126,234,0.4); }
    .btn-warning { background: linear-gradient(45deg, #ed8936, #dd6b20); box-shadow: 0 4px 15px rgba(237,137,54,0.3); }
    .btn-secondary { background: linear-gradient(45deg, #718096, #4a5568); box-shadow: 0 4px 15px rgba(113,128,150,0.3); }
    .alert { padding: 20px; border-radius: 10px; margin: 15px 0; border-left: 4px solid; }
    .alert-success { background: linear-gradient(45deg, #c6f6d5, #9ae6b4); color: #22543d; border-color: #38a169; }
    .alert-warning { background: linear-gradient(45deg, #fefcbf, #faf089); color: #744210; border-color: #ed8936; }
    .alert-danger { background: linear-gradient(45deg, #fed7d7, #fbb6ce); color: #742a2a; border-color: #e53e3e; }
    .notification { position: fixed; top: 20px; right: 20px; padding: 15px 20px; background: linear-gradient(45deg, #38a169, #48bb78); color: white; border-radius: 10px; z-index: 1000; transform: translateX(400px); transition: transform 0.3s; box-shadow: 0 8px 25px rgba(56,161,105,0.3); }
    .notification.show { transform: translateX(0); }
    .notification.warning { background: linear-gradient(45deg, #ed8936, #dd6b20); box-shadow: 0 8px 25px rgba(237,137,54,0.3); }
    .comparison-section { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px; }
    .stats-card { background: rgba(255,255,255,0.95); border-radius: 15px; padding: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); }
    .evolution-indicator { display: inline-flex; align-items: center; gap: 5px; font-size: 14px; padding: 4px 8px; border-radius: 20px; font-weight: 500; }
    .evolution-up { background: #c6f6d5; color: #22543d; }
    .evolution-down { background: #fed7d7; color: #742a2a; }
    .evolution-equal { background: #e2e8f0; color: #4a5568; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px 10px; border-bottom: 1px solid #e2e8f0; text-align: left; }
    th { font-size: 12px; text-transform: uppercase; letter-spacing: 0.8px; color: #4a5568; }
    tr:hover td { background: rgba(102,126,234,0.06); }

    /* === STYLES ENRICHIS === */
    .advanced-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 25px; }
    .war-room { background: linear-gradient(135deg, #1a1a2e, #16213e); border: 2px solid #667eea; color: white; }
    .war-room h3 { color: #667eea; margin-bottom: 20px; }
    .status-indicator { display: inline-flex; align-items: center; gap: 8px; }
    .status-dot { width: 8px; height: 8px; background: #48bb78; border-radius: 50%; animation: pulse 2s infinite; }
    .top-seller { background: linear-gradient(135deg, #38a169, #48bb78); color: white; border-radius: 12px; padding: 20px; }
    .top-seller h3 { margin-bottom: 15px; }
    .top-seller .name { font-size: 1.5rem; font-weight: bold; margin-bottom: 10px; }
    .top-seller .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .top-seller .stat { text-align: center; }
    .top-seller .stat-value { font-size: 1.2rem; font-weight: bold; }
    .top-seller .stat-label { font-size: 0.8rem; opacity: 0.9; }

    @media (max-width: 768px) {
      .header { flex-direction: column; gap: 20px; }
      .comparison-section { grid-template-columns: 1fr; }
      .overview-grid { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
      .cards-grid { grid-template-columns: 1fr; }
      .advanced-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>üìä Dashboard Commercial - CVL</h1>
    <div class="month-selector">
      <button type="button" class="month-btn" id="prev-month">‚Äπ</button>
      <span class="current-month" id="current-month"></span>
      <button type="button" class="month-btn" id="next-month">‚Ä∫</button>
    </div>
  </div>

  <div class="tabs">
    <button type="button" class="tab active" data-tab="vue-ensemble">üìà Vue d'ensemble</button>
    <button type="button" class="tab" data-tab="vendeurs">üë• Vendeurs</button>
    <button type="button" class="tab" data-tab="vue-annuelle">üóìÔ∏è Vue Annuelle</button>
    <button type="button" class="tab" data-tab="comparatif">üìä Comparatif</button>
    <button type="button" class="tab" data-tab="saisie">‚úèÔ∏è Saisie</button>
    <button type="button" class="tab" data-tab="ia">ü§ñ Pr√©diction IA</button>
    <button type="button" class="tab" data-tab="warroom">üö® War Room</button>
  </div>

  <!-- Vue d'ensemble -->
  <div id="vue-ensemble" class="tab-content active">
    <!-- KPIs principaux -->
    <div class="overview-grid">
      <div class="overview-card">
        <h3>Total Rendez-vous</h3>
        <div class="value neutral" id="total-prospects">0</div>
        <div class="trend" id="trend-prospects">
          <span>üìà</span>
          <span id="evolution-prospects">+0% vs mois dernier</span>
        </div>
      </div>
      <div class="overview-card">
        <h3>Total Ventes</h3>
        <div class="value positive" id="total-ventes">0</div>
        <div class="trend" id="trend-ventes">
          <span>üí∞</span>
          <span id="evolution-ventes">+0% vs mois dernier</span>
        </div>
      </div>
      <div class="overview-card">
        <h3>Taux Conversion</h3>
        <div class="value" id="taux-global">0%</div>
        <div class="trend" id="trend-taux">
          <span id="taux-icon">üìä</span>
          <span id="taux-status">Objectif 25%</span>
        </div>
      </div>
      <div class="overview-card">
        <h3>CA R√©alis√©</h3>
        <div class="value positive" id="ca-realise">0 ‚Ç¨</div>
        <div class="trend" id="trend-ca">
          <span>üíé</span>
          <span id="evolution-ca">vs objectif</span>
        </div>
      </div>
      <div class="overview-card">
        <h3>Marge Moyenne</h3>
        <div class="value" style="color: #ed8936;" id="marge-moyenne">0 ‚Ç¨</div>
        <div class="trend">
          <span>üí°</span>
          <span id="marge-evolution">par vente</span>
        </div>
      </div>
      <div class="overview-card">
        <h3>Pr√©vision Fin Mois</h3>
        <div class="value" style="color: #9f7aea;" id="prevision-ca">0 ‚Ç¨</div>
        <div class="trend">
          <span>üîÆ</span>
          <span id="prevision-status">tendance actuelle</span>
        </div>
      </div>
    </div>

    <!-- Graphiques de pr√©vision -->
    <div class="cards-grid" style="margin-bottom: 30px;">
      <div class="card">
        <h3>üìà Pr√©vision CA Fin de Mois</h3>
        <div style="height: 250px; position: relative;">
          <canvas id="prevision-chart" style="width: 100%; height: 100%;"></canvas>
        </div>
        <div style="display: flex; justify-content: space-between; margin-top: 15px; font-size: 0.9rem;">
          <div style="text-align: center;">
            <div style="font-weight: bold; color: #4a5568;">R√©alis√©</div>
            <div id="ca-actuel-chart">0‚Ç¨</div>
          </div>
          <div style="text-align: center;">
            <div style="font-weight: bold; color: #9f7aea;">Pr√©vision</div>
            <div id="ca-prevision-chart">0‚Ç¨</div>
          </div>
          <div style="text-align: center;">
            <div style="font-weight: bold; color: #38a169;">Objectif</div>
            <div id="ca-objectif-chart">0‚Ç¨</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>üí∞ Analyse des Marges par Vendeur</h3>
        <div id="marges-chart" style="height: 200px; display: flex; align-items: end; gap: 10px; padding: 20px 0;"></div>
        <div style="margin-top: 15px;">
          <div class="metric">
            <span>Marge totale g√©n√©r√©e</span>
            <span class="metric-value positive" id="marge-totale">0 ‚Ç¨</span>
          </div>
          <div class="metric">
            <span>Meilleure marge unitaire</span>
            <span class="metric-value positive" id="meilleure-marge">0 ‚Ç¨ (Vendeur)</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Insights avanc√©s -->
    <div class="cards-grid" style="margin-bottom: 30px;">
      <div class="card" style="background: linear-gradient(135deg, #4299e1, #3182ce); color: white;">
        <h3>üß† Insights Intelligents</h3>
        <div id="insights-container">
          <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 12px; margin-bottom: 10px;">
            <div style="font-weight: bold; margin-bottom: 5px;">üìä Performance</div>
            <div style="font-size: 0.9rem;" id="insight-performance">Analyse en cours...</div>
          </div>
          <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 12px; margin-bottom: 10px;">
            <div style="font-weight: bold; margin-bottom: 5px;">üéØ Recommandation</div>
            <div style="font-size: 0.9rem;" id="insight-recommandation">Calcul en cours...</div>
          </div>
          <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 12px;">
            <div style="font-weight: bold; margin-bottom: 5px;">‚ö° Action Prioritaire</div>
            <div style="font-size: 0.9rem;" id="insight-action">Identification en cours...</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>üìä Indicateurs de Performance</h3>
        <div class="metric">
          <span>CA moyen par vendeur</span>
          <span class="metric-value neutral" id="ca-moyen-vendeur">0 ‚Ç¨</span>
        </div>
        <div class="metric">
          <span>Temps moyen de cycle</span>
          <span class="metric-value neutral" id="cycle-moyen">~ jours</span>
        </div>
        <div class="metric">
          <span>Vendeur le plus r√©gulier</span>
          <span class="metric-value positive" id="vendeur-regulier">-</span>
        </div>
        <div class="metric">
          <span>Progression √©quipe</span>
          <span class="metric-value" id="progression-equipe-global">0%</span>
        </div>
        <div style="margin-top: 15px;">
          <div style="font-size: 0.8rem; color: #718096; margin-bottom: 5px;">R√©partition des objectifs</div>
          <div class="progress-bar" style="height: 6px;">
            <div id="repartition-objectifs" style="height: 100%; background: linear-gradient(90deg, #38a169 0%, #48bb78 50%, #68d391 100%); width: 0%; border-radius: 3px;"></div>
          </div>
        </div>
      </div>
    </div></div>

    <!-- Section enrichie -->
    <div class="advanced-grid">
      <!-- Top vendeur enrichi -->
      <div class="top-seller">
        <h3>üèÜ Top Performer du Mois</h3>
        <div class="name" id="top-vendeur-enrichi">-</div>
        <div class="stats">
          <div class="stat">
            <div class="stat-value" id="top-vendeur-ca-enrichi">0‚Ç¨</div>
            <div class="stat-label">CA Mensuel</div>
          </div>
          <div class="stat">
            <div class="stat-value" id="top-vendeur-taux-enrichi">0%</div>
            <div class="stat-label">Taux Conv.</div>
          </div>
          <div class="stat">
            <div class="stat-value" id="top-vendeur-progression-enrichi">0%</div>
            <div class="stat-label">Vs Objectif</div>
          </div>
          <div class="stat">
            <div class="stat-value" id="top-vendeur-ventes-enrichi">0</div>
            <div class="stat-label">Ventes</div>
          </div>
        </div>
        <div style="margin-top: 10px; font-size: 0.85rem; opacity: 0.9;" id="top-vendeur-details">
          Performance mensuelle
        </div>
      </div>

      <!-- Actions prioritaires -->
      <div class="card" style="background: linear-gradient(135deg, #ed8936, #dd6b20); color: white;">
        <h3>üéØ Actions Prioritaires</h3>
        <div id="actions-container">
          <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 12px; margin-bottom: 8px;">
            <div style="font-size: 0.8rem; font-weight: bold; margin-bottom: 4px;">üü° IMPORTANT</div>
            <div style="font-size: 0.9rem;">Analyser les performances de l'√©quipe</div>
          </div>
          <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 12px; margin-bottom: 8px;">
            <div style="font-size: 0.8rem; font-weight: bold; margin-bottom: 4px;">üü¢ OPTIMISATION</div>
            <div style="font-size: 0.9rem;">Partager les bonnes pratiques</div>
          </div>
        </div>
      </div>
    </div>

    <div class="chart-container">
      <h3 style="margin-bottom: 20px;">üìä CA par vendeur</h3>
      <div class="chart" id="chart-vendeurs"></div>
    </div>
    
    <div class="card">
      <h3>üèÜ Meilleur Vendeur du Mois</h3>
      <div class="metric"><span>Nom</span><span class="metric-value positive" id="top-vendeur">-</span></div>
      <div class="metric"><span>CA</span><span class="metric-value positive" id="top-ca">0 ‚Ç¨</span></div>
      <div class="metric"><span>Taux de conversion</span><span class="metric-value positive" id="top-taux">0%</span></div>
      <div class="metric"><span>Progression objectif</span><span class="metric-value positive" id="top-progression">0%</span></div>
    </div>
    <div id="alertes-marges"></div>
  </div>

  <!-- Vendeurs -->
  <div id="vendeurs" class="tab-content"><div class="cards-grid" id="vendeurs-grid"></div></div>

  <!-- Vue Annuelle -->
  <div id="vue-annuelle" class="tab-content">
    <div class="overview-grid">
      <div class="overview-card"><h3>CA Annuel</h3><div class="value positive" id="ca-annuel">0 ‚Ç¨</div></div>
      <div class="overview-card"><h3>Objectif Annuel</h3><div class="value neutral" id="objectif-annuel">0 ‚Ç¨</div></div>
      <div class="overview-card"><h3>Progression</h3><div class="value" id="progression-annuelle">0%</div></div>
      <div class="overview-card"><h3>Ventes Totales</h3><div class="value positive" id="ventes-annuelles">0</div></div>
    </div>
  </div>

  <!-- Comparatif -->
  <div id="comparatif" class="tab-content">
    <div class="comparison-section">
      <div class="stats-card"><h3>üìà √âvolution par rapport au mois pr√©c√©dent</h3><div id="evolution-content"></div></div>
      <div class="stats-card"><h3>üéØ Performance vs Objectifs</h3><div id="performance-content"></div></div>
    </div>
    <div class="chart-container"><h3 style="margin-bottom: 20px;">üìä √âvolution du CA sur 6 mois</h3><div class="chart" id="chart-evolution"></div></div>
  </div>

  <!-- Saisie -->
  <div id="saisie" class="tab-content">
    <div class="cards-grid">
      <div class="card">
        <h3>üìù Saisie des donn√©es</h3>
        <div class="input-group">
          <label for="vendeur-select">Vendeur</label>
          <select id="vendeur-select">
            <option value="Vincent">Vincent</option>
            <option value="Raphael">Raphael</option>
            <option value="L√©o">L√©o</option>
            <option value="Pablo">Pablo</option>
            <option value="Nathan">Nathan</option>
          </select>
        </div>

        <div class="input-group"><label for="prospects-input">Rendez-vous</label><input type="number" id="prospects-input" placeholder="Nombre de prospects" /></div>
        <div class="input-group"><label for="ventes-input">Ventes</label><input type="number" id="ventes-input" placeholder="Nombre de ventes" /></div>
        <div class="input-group"><label for="ca-input">CA (‚Ç¨)</label><input type="number" id="ca-input" placeholder="Chiffre d'affaires" /></div>
        <div class="input-group"><label for="marge-input">Marge moyenne / vente (‚Ç¨)</label><input type="number" id="marge-input" placeholder="Ex: 2500" min="0" step="50" /></div>
        <div class="input-group"><label for="objectif-input">Objectif mensuel (‚Ç¨)</label><input type="number" id="objectif-input" placeholder="Ex: 80000" min="0" step="1000" /></div>

        <button type="button" class="btn" id="save-btn">üíæ Sauvegarder</button>
      </div>

      <div class="card">
        <h3>‚öôÔ∏è Administration</h3>
        <button type="button" class="btn btn-secondary" id="export-btn">üì• Exporter donn√©es</button>
        <button type="button" class="btn" id="load-btn">‚¨áÔ∏è Charger depuis serveur</button>
        <button type="button" class="btn" id="save-server-btn">‚¨ÜÔ∏è Sauvegarder vers serveur</button>
        <button type="button" class="btn btn-warning" id="reset-month-btn">üîÑ R√©initialiser mois</button>
        <button type="button" class="btn btn-warning" id="reset-all-btn">üóëÔ∏è Tout effacer</button>
      </div>
    </div>
  </div>

  <!-- IA -->
  <div id="ia" class="tab-content">
    <div class="overview-grid">
      <div class="overview-card">
        <h3>Pr√©vision fin de mois (CA)</h3>
        <div class="value" id="ia-prev-ca">0 ‚Ç¨</div>
        <div class="trend" id="ia-prev-trend"></div>
      </div>
      <div class="overview-card">
        <h3>Pr√©vision Ventes</h3>
        <div class="value" id="ia-prev-ventes">0</div>
        <div class="trend" id="ia-prev-ventes-trend"></div>
      </div>
      <div class="overview-card">
        <h3>Taux conversion pr√©visionnel</h3>
        <div class="value" id="ia-prev-taux">0%</div>
      </div>
    </div>

    <div class="cards-grid">
      <div class="card">
        <h3>üß† Recommandations IA</h3>
        <div id="ia-suggestions"></div>
        <button type="button" class="btn" id="generate-ia-btn">üîÅ G√©n√©rer recommandations</button>
      </div>
    </div>
  </div>

  <!-- War Room -->
  <div id="warroom" class="tab-content">
    <div class="card war-room" style="margin-bottom: 20px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div style="display: flex; align-items: center; gap: 15px;">
          <span style="font-size: 2rem;">‚ö°</span>
          <h2 style="color: #667eea; margin: 0; font-size: 1.8rem;">War Room Commercial</h2>
          <div style="display: flex; align-items: center; gap: 8px;">
            <div style="width: 8px; height: 8px; background: #48bb78; border-radius: 50%; animation: pulse 2s infinite;"></div>
            <span style="font-size: 0.9rem; color: #a0aec0;">Temps r√©el</span>
          </div>
        </div>
        <button type="button" class="btn" id="refresh-war-room">üîÑ Actualiser</button>
      </div>
      
      <div class="overview-grid" style="margin-bottom: 0;">
        <div class="overview-card" style="background: rgba(255,255,255,0.1); color: white;">
          <h3 style="color: #a0aec0;">Vendeurs Actifs</h3>
          <div class="value" id="war-vendeurs-actifs">5</div>
        </div>
        <div class="overview-card" style="background: rgba(255,255,255,0.1); color: white;">
          <h3 style="color: #a0aec0;">Alertes Critiques</h3>
          <div class="value" style="color: #f56565;" id="war-alertes-critiques">0</div>
        </div>
        <div class="overview-card" style="background: rgba(255,255,255,0.1); color: white;">
          <h3 style="color: #a0aec0;">Taux √âquipe</h3>
          <div class="value" id="war-taux-equipe">0%</div>
        </div>
        <div class="overview-card" style="background: rgba(255,255,255,0.1); color: white;">
          <h3 style="color: #a0aec0;">CA √âquipe</h3>
          <div class="value" id="war-ca-equipe">0k‚Ç¨</div>
        </div>
      </div>

      <div style="margin-top: 25px;">
        <h3 style="color: #667eea; margin-bottom: 15px;">üéØ Alertes & Actions</h3>
        <div id="war-alertes-detaillees">
          <div style="background: rgba(56,161,105,0.2); color: #22543d; padding: 12px; border-radius: 8px; border-left: 4px solid #38a169;">
            ‚úÖ Aucune alerte critique - √âquipe performante
          </div>
        </div>
      </div>
    </div>

    <div style="text-align: center; margin-top: 20px; font-size: 0.8rem; color: #a0aec0;">
      Derni√®re mise √† jour : <span id="war-last-update">--</span>
    </div>
  </div>
</div>

<script>
console.log('üöÄ D√©marrage Dashboard v2.5 - Version Corrig√©e');

// === VARIABLES GLOBALES ===
const DATASET = new URLSearchParams(location.search).get('d') || 'default';
const MOIS_NOMS = ['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'];
let moisActuel = new Date().getMonth();
let anneeActuelle = new Date().getFullYear();
let donneesParMois = {};

// === FONCTIONS UTILITAIRES ===
function vendeurDefaults(){
  return {
    'Vincent': { prospects:0, ventes:0, ca:0, objectif:80000, margeValeur:2500 },
    'Raphael': { prospects:0, ventes:0, ca:0, objectif:100000, margeValeur:2600 },
    'L√©o':     { prospects:0, ventes:0, ca:0, objectif:75000, margeValeur:2200 },
    'Pablo':   { prospects:0, ventes:0, ca:0, objectif:90000, margeValeur:2400 },
    'Nathan':  { prospects:0, ventes:0, ca:0, objectif:85000, margeValeur:2300 }
  };
}

function getMoisKey(mois=moisActuel, annee=anneeActuelle){ 
  return `${annee}-${mois}`; 
}

function getDonneesActuelles(){
  const key = getMoisKey();
  if (!donneesParMois[key]) donneesParMois[key] = vendeurDefaults();
  return donneesParMois[key];
}

function initialiserDonnees(){
  for(let mois=0; mois<12; mois++){
    const key = `${anneeActuelle}-${mois}`;
    if(!donneesParMois[key]){
      donneesParMois[key] = vendeurDefaults();
    }
  }
}

function showNotification(message, type='success'){
  console.log(`üì¢ ${message}`);
  const n = document.createElement('div'); 
  n.className = `notification ${type}`; 
  n.textContent = message; 
  document.body.appendChild(n);
  setTimeout(() => n.classList.add('show'), 100); 
  setTimeout(() => { 
    n.classList.remove('show'); 
    setTimeout(() => {
      if (document.body.contains(n)) {
        document.body.removeChild(n);
      }
    }, 300); 
  }, 3000);
}

// === FONCTIONS ENRICHIES ===
function updateTopVendeurEnrichi() {
  const d = getDonneesActuelles();
  let bestVendeur = null;
  let bestCA = 0;
  
  for(const v in d) {
    const x = d[v];
    if ((x.ca || 0) > bestCA) {
      bestCA = x.ca || 0;
      bestVendeur = {
        nom: v,
        ca: x.ca || 0,
        prospects: x.prospects || 0,
        ventes: x.ventes || 0,
        objectif: x.objectif || 0
      };
    }
  }
  
  if (bestVendeur) {
    const taux = bestVendeur.prospects > 0 ? (bestVendeur.ventes / bestVendeur.prospects * 100) : 0;
    const progression = bestVendeur.objectif > 0 ? (bestVendeur.ca / bestVendeur.objectif * 100) : 0;
    
    const elements = {
      'top-vendeur-enrichi': bestVendeur.nom,
      'top-vendeur-ca-enrichi': `${(bestVendeur.ca / 1000).toFixed(0)}k‚Ç¨`,
      'top-vendeur-taux-enrichi': `${taux.toFixed(1)}%`,
      'top-vendeur-progression-enrichi': `${progression.toFixed(0)}%`,
      'top-vendeur-ventes-enrichi': bestVendeur.ventes
    };
    
    for(const [id, value] of Object.entries(elements)) {
      const el = document.getElementById(id);
      if (el) el.textContent = value;
    }
    
    const detailsEl = document.getElementById('top-vendeur-details');
    if (detailsEl) {
      let message = '';
      if (progression >= 100) {
        message = 'üéØ Objectif atteint ! Performance exceptionnelle';
      } else if (progression >= 75) {
        message = 'üî• En excellente voie vers l\'objectif';
      } else if (progression >= 50) {
        message = 'üìà Bonne progression, maintenir le rythme';
      } else {
        message = '‚ö° Acc√©l√©ration n√©cessaire';
      }
      detailsEl.textContent = message;
    }
  }
}

function updateActionsContainer() {
  const container = document.getElementById('actions-container');
  if (!container) return;
  
  const d = getDonneesActuelles();
  const actions = [];
  
  // Analyser les performances pour g√©n√©rer des actions
  for(const v in d) {
    const x = d[v];
    const progression = x.objectif > 0 ? (x.ca / x.objectif * 100) : 0;
    const taux = x.prospects > 0 ? (x.ventes / x.prospects * 100) : 0;
    
    if (progression < 50) {
      actions.push({
        priorite: 'URGENT',
        description: `Coaching ${v} - ${progression.toFixed(0)}% objectif`,
        icon: 'üî¥'
      });
    }
    
    if (taux < 20 && x.prospects > 3) {
      actions.push({
        priorite: 'IMPORTANT',
        description: `Formation closing ${v} - Taux ${taux.toFixed(1)}%`,
        icon: 'üü°'
      });
    }
  }
  
  // Actions g√©n√©rales
  const joursRestants = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate() - new Date().getDate();
  if (joursRestants < 10) {
    actions.push({
      priorite: 'URGENT',
      description: `Sprint final - ${joursRestants} jours restants`,
      icon: 'üî¥'
    });
  }
  
  if (actions.length === 0) {
    actions.push({
      priorite: 'OPTIMISATION',
      description: '√âquipe performante - Maintenir le cap',
      icon: 'üü¢'
    });
  }
  
  let html = '';
  actions.slice(0, 3).forEach(action => {
    html += `
      <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 12px; margin-bottom: 8px;">
        <div style="font-size: 0.8rem; font-weight: bold; margin-bottom: 4px;">${action.icon} ${action.priorite}</div>
        <div style="font-size: 0.9rem;">${action.description}</div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

function updateJoursRestants() {
  const today = new Date();
  const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
  const joursRestants = lastDay.getDate() - today.getDate();
  
  const element = document.getElementById('jours-restants');
  if (element) {
    element.textContent = `J+${today.getDate()}/${lastDay.getDate()} (${joursRestants}j restants)`;
  }
}

// War Room
function updateWarRoom() {
  console.log('üö® Mise √† jour War Room');
  const d = getDonneesActuelles();
  const vendeurs = Object.keys(d);
  
  let alertesCount = 0;
  let vendeursActifs = 0;
  let totalCA = 0;
  let totalProspects = 0;
  let totalVentes = 0;
  
  vendeurs.forEach(vendeur => {
    const donnees = d[vendeur] || {};
    const rdv = donnees.prospects || 0;
    const ventes = donnees.ventes || 0;
    const ca = donnees.ca || 0;
    const objectif = donnees.objectif || 0;
    
    if (rdv > 0) vendeursActifs++;
    totalCA += ca;
    totalProspects += rdv;
    totalVentes += ventes;
    
    const progression = objectif > 0 ? (ca / objectif) * 100 : 0;
    const tauxConversion = rdv > 0 ? (ventes / rdv) * 100 : 0;
    
    if (progression < 50 && objectif > 0) alertesCount++;
    if (tauxConversion < 20 && rdv > 5) alertesCount++;
  });
  
  const moyenneTaux = totalProspects > 0 ? (totalVentes / totalProspects * 100) : 0;
  
  const elements = {
    'war-vendeurs-actifs': vendeursActifs,
    'war-alertes-critiques': alertesCount,
    'war-taux-equipe': moyenneTaux.toFixed(1) + '%',
    'war-ca-equipe': (totalCA / 1000).toFixed(0) + 'k‚Ç¨'
  };
  
  for(const [id, value] of Object.entries(elements)) {
    const el = document.getElementById(id);
    if (el) el.textContent = value;
  }
  
  // Mise √† jour des alertes d√©taill√©es
  const alertesContainer = document.getElementById('war-alertes-detaillees');
  if (alertesContainer) {
    let alertesHtml = '';
    
    if (alertesCount === 0) {
      alertesHtml = '<div style="background: rgba(56,161,105,0.2); color: #22543d; padding: 12px; border-radius: 8px; border-left: 4px solid #38a169;">‚úÖ Aucune alerte critique - √âquipe performante</div>';
    } else {
      alertesHtml = `<div style="background: rgba(237,137,54,0.2); color: #744210; padding: 12px; border-radius: 8px; border-left: 4px solid #ed8936;">‚ö†Ô∏è ${alertesCount} alerte(s) d√©tect√©e(s) - V√©rifiez les performances individuelles</div>`;
    }
    
    alertesContainer.innerHTML = alertesHtml;
  }
  
  // Mise √† jour de l'heure
  const lastUpdateEl = document.getElementById('war-last-update');
  if (lastUpdateEl) {
    lastUpdateEl.textContent = new Date().toLocaleTimeString('fr-FR', {
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    });
  }
}

// === NAVIGATION MOIS ===
function changerMois(direction) {
  console.log(`üìÖ Changement mois: ${direction}`);
  moisActuel += direction;
  if(moisActuel < 0) { moisActuel = 11; anneeActuelle--; }
  else if(moisActuel > 11) { moisActuel = 0; anneeActuelle++; }
  
  const key = getMoisKey();
  if(!donneesParMois[key]) { 
    donneesParMois[key] = vendeurDefaults(); 
  }
  
  updateMoisAffichage();
  updateActiveTab();
}

function updateMoisAffichage(){
  const el = document.getElementById('current-month');
  if (el) {
    el.textContent = `${MOIS_NOMS[moisActuel]} ${anneeActuelle}`;
  }
}

// === GESTION ONGLETS ===
function showTab(tabName) {
  console.log(`üîÑ Affichage onglet: ${tabName}`);
  
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  
  const content = document.getElementById(tabName);
  const tab = document.querySelector(`[data-tab="${tabName}"]`);
  
  if (content) content.classList.add('active');
  if (tab) tab.classList.add('active');
  
  updateTabContent(tabName);
}

function updateActiveTab() {
  const activeTab = document.querySelector('.tab.active');
  if (activeTab) {
    const tabName = activeTab.getAttribute('data-tab');
    updateTabContent(tabName);
  }
}

function updateTabContent(tabName) {
  console.log(`üîÑ Mise √† jour contenu: ${tabName}`);
  
  switch(tabName) {
    case 'vue-ensemble': 
      updateVueEnsemble(); 
      break;
    case 'vendeurs': 
      updateVendeurs(); 
      break;
    case 'vue-annuelle': 
      updateVueAnnuelle(); 
      break;
    case 'comparatif': 
      updateComparatif(); 
      break;
    case 'ia': 
      updateIATab(); 
      break;
    case 'saisie': 
      updateSaisieFields(); 
      break;
    case 'warroom': 
      updateWarRoom(); 
      break;
    default:
      console.log(`‚ö†Ô∏è Onglet inconnu: ${tabName}`);
  }
}

// === MISE √Ä JOUR CONTENU ===
function updateVueEnsemble() {
  console.log('üìä Mise √† jour vue ensemble');
  const d = getDonneesActuelles();
  
  let totalProspects = 0, totalVentes = 0, totalCA = 0, totalObjectif = 0, totalMarge = 0;
  let bestVendeur = '', bestCA = 0;
  let vendeurStats = [];
  
  for(const v in d) {
    const x = d[v];
    const prospects = x.prospects || 0;
    const ventes = x.ventes || 0;
    const ca = x.ca || 0;
    const objectif = x.objectif || 0;
    const margeUnitaire = x.margeValeur || 2500;
    const margeGeneree = ventes * margeUnitaire;
    
    totalProspects += prospects;
    totalVentes += ventes;
    totalCA += ca;
    totalObjectif += objectif;
    totalMarge += margeGeneree;
    
    vendeurStats.push({
      nom: v,
      prospects,
      ventes,
      ca,
      objectif,
      margeUnitaire,
      margeGeneree,
      taux: prospects > 0 ? (ventes / prospects * 100) : 0,
      progression: objectif > 0 ? (ca / objectif * 100) : 0
    });
    
    if(ca > bestCA) {
      bestCA = ca;
      bestVendeur = v;
    }
  }
  
  const tauxGlobal = totalProspects > 0 ? (totalVentes / totalProspects * 100) : 0;
  const progressionCA = totalObjectif > 0 ? (totalCA / totalObjectif * 100) : 0;
  const margeMoyenne = totalVentes > 0 ? (totalMarge / totalVentes) : 0;
  const caParVendeur = vendeurStats.length > 0 ? (totalCA / vendeurStats.length) : 0;
  
  // Calcul pr√©vision fin de mois
  const jourActuel = new Date().getDate();
  const joursDansMois = new Date(anneeActuelle, moisActuel + 1, 0).getDate();
  const previsionCA = totalCA * (joursDansMois / jourActuel);
  
  // Calculs d'√©volution (simulation par rapport au mois pr√©c√©dent)
  const evolutionProspects = Math.round((Math.random() - 0.5) * 30); // Simulation
  const evolutionVentes = Math.round((Math.random() - 0.5) * 25);
  const evolutionCA = Math.round((Math.random() - 0.5) * 20);
  
  // Mise √† jour des KPIs principaux
  const elements = {
    'total-prospects': totalProspects,
    'total-ventes': totalVentes,
    'taux-global': tauxGlobal.toFixed(1) + '%',
    'ca-realise': totalCA.toLocaleString() + ' ‚Ç¨',
    'marge-moyenne': Math.round(margeMoyenne).toLocaleString() + ' ‚Ç¨',
    'prevision-ca': Math.round(previsionCA).toLocaleString() + ' ‚Ç¨',
    'ca-moyen-vendeur': Math.round(caParVendeur).toLocaleString() + ' ‚Ç¨',
    'marge-totale': totalMarge.toLocaleString() + ' ‚Ç¨',
    'progression-equipe-global': progressionCA.toFixed(1) + '%'
  };
  
  for(const [id, value] of Object.entries(elements)) {
    const el = document.getElementById(id);
    if (el) el.textContent = value;
  }
  
  // √âvolutions vs mois pr√©c√©dent
  document.getElementById('evolution-prospects').textContent = 
    `${evolutionProspects > 0 ? '+' : ''}${evolutionProspects}% vs mois dernier`;
  document.getElementById('evolution-ventes').textContent = 
    `${evolutionVentes > 0 ? '+' : ''}${evolutionVentes}% vs mois dernier`;
  document.getElementById('evolution-ca').textContent = 
    `${progressionCA.toFixed(0)}% de l'objectif`;
  
  // Statut du taux de conversion
  const tauxIcon = document.getElementById('taux-icon');
  const tauxStatus = document.getElementById('taux-status');
  if (tauxGlobal >= 25) {
    tauxIcon.textContent = 'üéØ';
    tauxStatus.textContent = 'Objectif atteint !';
    tauxStatus.style.color = '#38a169';
  } else if (tauxGlobal >= 20) {
    tauxIcon.textContent = 'üìà';
    tauxStatus.textContent = 'Proche objectif';
    tauxStatus.style.color = '#ed8936';
  } else {
    tauxIcon.textContent = '‚ö†Ô∏è';
    tauxStatus.textContent = 'Am√©lioration n√©cessaire';
    tauxStatus.style.color = '#e53e3e';
  }
  
  // Statut de la pr√©vision
  const previsionStatus = document.getElementById('prevision-status');
  const ecartPrevision = ((previsionCA - totalObjectif) / totalObjectif * 100);
  if (ecartPrevision >= 0) {
    previsionStatus.textContent = `+${ecartPrevision.toFixed(0)}% vs objectif`;
    previsionStatus.style.color = '#38a169';
  } else {
    previsionStatus.textContent = `${ecartPrevision.toFixed(0)}% vs objectif`;
    previsionStatus.style.color = '#e53e3e';
  }
  
  // Meilleure marge
  const meilleureMargeVendeur = vendeurStats.reduce((max, v) => 
    v.margeUnitaire > max.margeUnitaire ? v : max, vendeurStats[0] || {margeUnitaire: 0, nom: '-'});
  document.getElementById('meilleure-marge').textContent = 
    `${meilleureMargeVendeur.margeUnitaire.toLocaleString()} ‚Ç¨ (${meilleureMargeVendeur.nom})`;
  
  // Vendeur le plus r√©gulier (simulation bas√©e sur √©cart-type)
  const vendeurRegulier = vendeurStats.find(v => v.taux >= 20 && v.taux <= 30)?.nom || 
                         vendeurStats.sort((a, b) => Math.abs(a.taux - 25) - Math.abs(b.taux - 25))[0]?.nom || '-';
  document.getElementById('vendeur-regulier').textContent = vendeurRegulier;
  
  // Temps de cycle moyen (simulation)
  const cycleSimule = Math.round(15 + Math.random() * 10);
  document.getElementById('cycle-moyen').textContent = `~${cycleSimule} jours`;
  
  // R√©partition des objectifs
  document.getElementById('repartition-objectifs').style.width = `${Math.min(100, progressionCA)}%`;
  
  // Mise √† jour des graphiques
  updatePrevisionChart(totalCA, previsionCA, totalObjectif);
  updateMargesChart(vendeurStats);
  updateInsights(vendeurStats, tauxGlobal, progressionCA, previsionCA, totalObjectif);
  
  // Mise √† jour des autres sections
  updateTopVendeurEnrichi();
  updateActionsContainer();
  updateJoursRestants();
  updateChart();
  updateAlertes();
}

function updatePrevisionChart(caActuel, previsionCA, objectifCA) {
  const canvas = document.getElementById('prevision-chart');
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  const width = canvas.offsetWidth;
  const height = canvas.offsetHeight;
  canvas.width = width;
  canvas.height = height;
  
  ctx.clearRect(0, 0, width, height);
  
  // Configuration du graphique
  const padding = 40;
  const chartWidth = width - 2 * padding;
  const chartHeight = height - 2 * padding;
  
  // Donn√©es pour la courbe (jour par jour)
  const jourActuel = new Date().getDate();
  const joursDansMois = new Date(anneeActuelle, moisActuel + 1, 0).getDate();
  const maxValue = Math.max(previsionCA, objectifCA) * 1.1;
  
  // Points de donn√©es
  const points = [];
  const caParJour = caActuel / jourActuel;
  
  // G√©n√©ration des points pour la courbe r√©alis√©e
  for (let jour = 1; jour <= jourActuel; jour++) {
    const ca = caParJour * jour + (Math.random() - 0.5) * caParJour * 0.3; // Variation r√©aliste
    points.push({
      x: padding + (jour / joursDansMois) * chartWidth,
      y: padding + chartHeight - (ca / maxValue) * chartHeight,
      value: ca,
      type: 'realized'
    });
  }
  
  // Points pour la pr√©vision
  for (let jour = jourActuel + 1; jour <= joursDansMois; jour++) {
    const ca = caParJour * jour;
    points.push({
      x: padding + (jour / joursDansMois) * chartWidth,
      y: padding + chartHeight - (ca / maxValue) * chartHeight,
      value: ca,
      type: 'forecast'
    });
  }
  
  // Ligne de l'objectif
  const objectifY = padding + chartHeight - (objectifCA / maxValue) * chartHeight;
  
  // Dessiner la grille
  ctx.strokeStyle = '#e2e8f0';
  ctx.lineWidth = 1;
  
  // Lignes horizontales
  for (let i = 0; i <= 4; i++) {
    const y = padding + (chartHeight / 4) * i;
    ctx.beginPath();
    ctx.moveTo(padding, y);
    ctx.lineTo(padding + chartWidth, y);
    ctx.stroke();
    
    // Labels des valeurs
    const value = maxValue - (maxValue / 4) * i;
    ctx.fillStyle = '#a0aec0';
    ctx.font = '10px Arial';
    ctx.textAlign = 'right';
    ctx.fillText(`${(value / 1000).toFixed(0)}k‚Ç¨`, padding - 5, y + 3);
  }
  
  // Lignes verticales (tous les 5 jours)
  for (let jour = 5; jour <= joursDansMois; jour += 5) {
    const x = padding + (jour / joursDansMois) * chartWidth;
    ctx.beginPath();
    ctx.moveTo(x, padding);
    ctx.lineTo(x, padding + chartHeight);
    ctx.stroke();
    
    // Labels des jours
    ctx.fillStyle = '#a0aec0';
    ctx.font = '10px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(`J${jour}`, x, height - 10);
  }
  
  // Ligne d'objectif
  ctx.strokeStyle = '#38a169';
  ctx.lineWidth = 2;
  ctx.setLineDash([5, 5]);
  ctx.beginPath();
  ctx.moveTo(padding, objectifY);
  ctx.lineTo(padding + chartWidth, objectifY);
  ctx.stroke();
  ctx.setLineDash([]);
  
  // Label objectif
  ctx.fillStyle = '#38a169';
  ctx.font = 'bold 11px Arial';
  ctx.textAlign = 'left';
  ctx.fillText('Objectif', padding + chartWidth - 60, objectifY - 5);
  
  // Zone r√©alis√©e (d√©grad√©)
  const realizedPoints = points.filter(p => p.type === 'realized');
  if (realizedPoints.length > 1) {
    const gradient = ctx.createLinearGradient(0, padding, 0, padding + chartHeight);
    gradient.addColorStop(0, 'rgba(102, 126, 234, 0.3)');
    gradient.addColorStop(1, 'rgba(102, 126, 234, 0.05)');
    
    ctx.fillStyle = gradient;
    ctx.beginPath();
    ctx.moveTo(realizedPoints[0].x, padding + chartHeight);
    realizedPoints.forEach(point => ctx.lineTo(point.x, point.y));
    ctx.lineTo(realizedPoints[realizedPoints.length - 1].x, padding + chartHeight);
    ctx.closePath();
    ctx.fill();
  }
  
  // Zone pr√©vision (d√©grad√©)
  const forecastPoints = points.filter(p => p.type === 'forecast');
  if (forecastPoints.length > 1) {
    const gradient = ctx.createLinearGradient(0, padding, 0, padding + chartHeight);
    gradient.addColorStop(0, 'rgba(159, 122, 234, 0.2)');
    gradient.addColorStop(1, 'rgba(159, 122, 234, 0.05)');
    
    ctx.fillStyle = gradient;
    ctx.beginPath();
    if (realizedPoints.length > 0) {
      const lastRealized = realizedPoints[realizedPoints.length - 1];
      ctx.moveTo(lastRealized.x, padding + chartHeight);
      ctx.lineTo(lastRealized.x, lastRealized.y);
    }
    forecastPoints.forEach(point => ctx.lineTo(point.x, point.y));
    ctx.lineTo(forecastPoints[forecastPoints.length - 1].x, padding + chartHeight);
    ctx.closePath();
    ctx.fill();
  }
  
  // Courbe r√©alis√©e
  if (realizedPoints.length > 1) {
    ctx.strokeStyle = '#667eea';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(realizedPoints[0].x, realizedPoints[0].y);
    
    for (let i = 1; i < realizedPoints.length; i++) {
      const prev = realizedPoints[i - 1];
      const curr = realizedPoints[i];
      const cpx = prev.x + (curr.x - prev.x) * 0.5;
      ctx.bezierCurveTo(cpx, prev.y, cpx, curr.y, curr.x, curr.y);
    }
    ctx.stroke();
  }
  
  // Courbe pr√©vision
  if (forecastPoints.length > 1) {
    ctx.strokeStyle = '#9f7aea';
    ctx.lineWidth = 3;
    ctx.setLineDash([8, 4]);
    ctx.beginPath();
    
    if (realizedPoints.length > 0) {
      const lastRealized = realizedPoints[realizedPoints.length - 1];
      ctx.moveTo(lastRealized.x, lastRealized.y);
      ctx.lineTo(forecastPoints[0].x, forecastPoints[0].y);
    } else {
      ctx.moveTo(forecastPoints[0].x, forecastPoints[0].y);
    }
    
    for (let i = 1; i < forecastPoints.length; i++) {
      const prev = forecastPoints[i - 1];
      const curr = forecastPoints[i];
      const cpx = prev.x + (curr.x - prev.x) * 0.5;
      ctx.bezierCurveTo(cpx, prev.y, cpx, curr.y, curr.x, curr.y);
    }
    ctx.stroke();
    ctx.setLineDash([]);
  }
  
  // Points de donn√©es actuels
  if (realizedPoints.length > 0) {
    const lastPoint = realizedPoints[realizedPoints.length - 1];
    ctx.fillStyle = '#667eea';
    ctx.beginPath();
    ctx.arc(lastPoint.x, lastPoint.y, 6, 0, 2 * Math.PI);
    ctx.fill();
    
    // Point blanc au centre
    ctx.fillStyle = 'white';
    ctx.beginPath();
    ctx.arc(lastPoint.x, lastPoint.y, 3, 0, 2 * Math.PI);
    ctx.fill();
  }
  
  // L√©gende
  const legendY = padding + 15;
  
  // R√©alis√©
  ctx.strokeStyle = '#667eea';
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.moveTo(padding + 10, legendY);
  ctx.lineTo(padding + 30, legendY);
  ctx.stroke();
  
  ctx.fillStyle = '#4a5568';
  ctx.font = '11px Arial';
  ctx.textAlign = 'left';
  ctx.fillText('R√©alis√©', padding + 35, legendY + 4);
  
  // Pr√©vision
  ctx.strokeStyle = '#9f7aea';
  ctx.lineWidth = 3;
  ctx.setLineDash([8, 4]);
  ctx.beginPath();
  ctx.moveTo(padding + 90, legendY);
  ctx.lineTo(padding + 110, legendY);
  ctx.stroke();
  ctx.setLineDash([]);
  
  ctx.fillStyle = '#4a5568';
  ctx.fillText('Pr√©vision', padding + 115, legendY + 4);
  
  // Objectif
  ctx.strokeStyle = '#38a169';
  ctx.lineWidth = 2;
  ctx.setLineDash([5, 5]);
  ctx.beginPath();
  ctx.moveTo(padding + 180, legendY);
  ctx.lineTo(padding + 200, legendY);
  ctx.stroke();
  ctx.setLineDash([]);
  
  ctx.fillStyle = '#4a5568';
  ctx.fillText('Objectif', padding + 205, legendY + 4);
  
  // Mise √† jour des labels
  document.getElementById('ca-actuel-chart').textContent = `${(caActuel / 1000).toFixed(0)}k‚Ç¨`;
  document.getElementById('ca-prevision-chart').textContent = `${(previsionCA / 1000).toFixed(0)}k‚Ç¨`;
  document.getElementById('ca-objectif-chart').textContent = `${(objectifCA / 1000).toFixed(0)}k‚Ç¨`;
}

function updateMargesChart(vendeurStats) {
  const container = document.getElementById('marges-chart');
  if (!container) return;
  
  container.innerHTML = '';
  const maxMarge = Math.max(...vendeurStats.map(v => v.margeGeneree), 1);
  
  vendeurStats.forEach(vendeur => {
    const height = Math.max(20, (vendeur.margeGeneree / maxMarge) * 150);
    const barContainer = document.createElement('div');
    barContainer.style.cssText = `
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    `;
    
    const bar = document.createElement('div');
    bar.style.cssText = `
      width: 100%;
      max-width: 40px;
      height: ${height}px;
      background: linear-gradient(to top, #ed8936, #f6ad55);
      border-radius: 4px 4px 0 0;
      position: relative;
      transition: all 0.3s;
      cursor: pointer;
    `;
    
    const value = document.createElement('div');
    value.style.cssText = `
      position: absolute;
      top: -20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 10px;
      font-weight: bold;
      color: #4a5568;
      white-space: nowrap;
    `;
    value.textContent = `${(vendeur.margeGeneree / 1000).toFixed(0)}k‚Ç¨`;
    
    const label = document.createElement('div');
    label.style.cssText = `
      font-size: 11px;
      color: #4a5568;
      text-align: center;
      font-weight: 500;
    `;
    label.textContent = vendeur.nom;
    
    bar.appendChild(value);
    barContainer.appendChild(bar);
    barContainer.appendChild(label);
    container.appendChild(barContainer);
  });
}

function updateInsights(vendeurStats, tauxGlobal, progressionCA, previsionCA, objectifCA) {
  // Insight Performance
  let performanceText = '';
  if (tauxGlobal >= 25) {
    performanceText = `Excellente performance √©quipe avec ${tauxGlobal.toFixed(1)}% de conversion`;
  } else if (tauxGlobal >= 20) {
    performanceText = `Performance correcte √† ${tauxGlobal.toFixed(1)}%, am√©lioration possible`;
  } else {
    performanceText = `Performance en dessous de l'objectif (${tauxGlobal.toFixed(1)}%), action requise`;
  }
  
  // Insight Recommandation
  let recommandationText = '';
  const vendeursEnDifficulte = vendeurStats.filter(v => v.taux < 20).length;
  if (vendeursEnDifficulte > 0) {
    recommandationText = `${vendeursEnDifficulte} vendeur(s) ont besoin de coaching en closing`;
  } else if (progressionCA < 75) {
    recommandationText = 'Intensifier la prospection pour atteindre les objectifs';
  } else {
    recommandationText = 'Maintenir le rythme, objectifs en bonne voie';
  }
  
  // Insight Action
  let actionText = '';
  if (previsionCA < objectifCA) {
    const manque = objectifCA - previsionCA;
    actionText = `Acc√©l√©rer les ventes : ${(manque/1000).toFixed(0)}k‚Ç¨ manquants`;
  } else {
    actionText = 'Objectif en voie d\'√™tre d√©pass√©, excellente trajectoire !';
  }
  
  document.getElementById('insight-performance').textContent = performanceText;
  document.getElementById('insight-recommandation').textContent = recommandationText;
  document.getElementById('insight-action').textContent = actionText;
}

function updateChart() {
  const chart = document.getElementById('chart-vendeurs');
  if (!chart) return;
  
  const d = getDonneesActuelles();
  const vendeurs = Object.keys(d);
  let html = '';
  const maxCA = Math.max(...vendeurs.map(v => d[v].ca || 0), 1);
  
  vendeurs.forEach(v => {
    const x = d[v];
    const height = Math.max(30, ((x.ca || 0) / maxCA) * 160);
    html += `
      <div class="bar-group">
        <div class="bar" style="height:${height}px;">
          <div class="bar-value">${((x.ca || 0) / 1000).toFixed(0)}k‚Ç¨</div>
        </div>
        <div class="bar-label">${v}</div>
      </div>
    `;
  });
  
  chart.innerHTML = html;
}

function updateAlertes() {
  const container = document.getElementById('alertes-marges');
  if (!container) return;
  
  const d = getDonneesActuelles();
  let alertes = [];
  
  for(const v in d) {
    const x = d[v];
    const prog = x.objectif > 0 ? ((x.ca || 0) / x.objectif * 100) : 0;
    if(prog < 50) {
      alertes.push(`${v} : ${prog.toFixed(1)}% de son objectif`);
    }
  }
  
  container.innerHTML = alertes.length === 0 ? 
    `<div class="alert alert-success"><strong>‚úÖ Excellent !</strong> Tous les vendeurs progressent bien.</div>` : 
    `<div class="alert alert-warning"><strong>‚ö†Ô∏è ${alertes.length} vendeur(s) en retard :</strong><br>${alertes.join('<br>')}</div>`;
}

function updateVendeurs() {
  console.log('üë• Mise √† jour vendeurs');
  const grid = document.getElementById('vendeurs-grid');
  if (!grid) return;
  
  const d = getDonneesActuelles();
  grid.innerHTML = '';
  
  for(const v in d) {
    const x = d[v];
    const taux = (x.prospects || 0) > 0 ? ((x.ventes || 0) / x.prospects * 100) : 0;
    const prog = (x.objectif || 0) > 0 ? ((x.ca || 0) / x.objectif * 100) : 0;
    
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <h3>üë§ ${v}</h3>
      <div class="metric"><span>Prospects</span><span class="metric-value neutral">${x.prospects || 0}</span></div>
      <div class="metric"><span>Ventes</span><span class="metric-value positive">${x.ventes || 0}</span></div>
      <div class="metric"><span>CA</span><span class="metric-value positive">${(x.ca || 0).toLocaleString()} ‚Ç¨</span></div>
      <div class="metric"><span>Taux conversion</span><span class="metric-value ${taux >= 25 ? 'positive' : 'neutral'}">${taux.toFixed(1)}%</span></div>
      <div class="metric"><span>Progression</span><span class="metric-value ${prog >= 100 ? 'positive' : 'neutral'}">${prog.toFixed(1)}%</span></div>
      <div class="progress-bar"><div class="progress-fill" style="width:${Math.min(100, prog)}%"></div></div>
    `;
    grid.appendChild(card);
  }
}

function updateVueAnnuelle() {
  console.log('üóìÔ∏è Mise √† jour vue annuelle');
  let caAnnuel = 0;
  let ventesAnnuelles = 0;
  
  for(let mois = 0; mois < 12; mois++) {
    const key = `${anneeActuelle}-${mois}`;
    const donneesMois = donneesParMois[key] || {};
    
    for(const vendeur in donneesMois) {
      const data = donneesMois[vendeur];
      caAnnuel += data.ca || 0;
      ventesAnnuelles += data.ventes || 0;
    }
  }
  
  const elements = {
    'ca-annuel': caAnnuel.toLocaleString() + ' ‚Ç¨',
    'ventes-annuelles': ventesAnnuelles
  };
  
  for(const [id, value] of Object.entries(elements)) {
    const el = document.getElementById(id);
    if (el) el.textContent = value;
  }
}

function updateComparatif() {
  console.log('üìä Mise √† jour comparatif');
  updateEvolution();
  updatePerformance();
}

function updateEvolution() {
  const container = document.getElementById('evolution-content');
  if (!container) return;
  
  container.innerHTML = '<div class="metric"><span>√âvolution CA</span><span class="positive">En cours de calcul...</span></div>';
}

function updatePerformance() {
  const container = document.getElementById('performance-content');
  if (!container) return;
  
  const d = getDonneesActuelles();
  let html = '';
  
  for(const v in d) {
    const x = d[v];
    const prog = (x.objectif || 0) > 0 ? ((x.ca || 0) / x.objectif * 100) : 0;
    const status = prog >= 100 ? 'positive' : prog >= 75 ? 'neutral' : 'negative';
    const icon = prog >= 100 ? 'üéØ' : prog >= 75 ? 'üìà' : '‚ö†Ô∏è';
    html += `<div class="metric"><span>${icon} ${v}</span><span class="metric-value ${status}">${prog.toFixed(1)}%</span></div>`;
  }
  
  container.innerHTML = html;
}

function updateIATab() {
  console.log('ü§ñ Mise √† jour IA');
  const d = getDonneesActuelles();
  
  let totalCA = 0;
  let totalVentes = 0;
  
  for(const v in d) {
    totalCA += d[v].ca || 0;
    totalVentes += d[v].ventes || 0;
  }
  
  const jourActuel = new Date().getDate();
  const joursDansMois = new Date(anneeActuelle, moisActuel + 1, 0).getDate();
  const previsionCA = Math.round(totalCA * (joursDansMois / jourActuel));
  const previsionVentes = Math.round(totalVentes * (joursDansMois / jourActuel));
  
  const elements = {
    'ia-prev-ca': previsionCA.toLocaleString() + ' ‚Ç¨',
    'ia-prev-ventes': previsionVentes,
    'ia-prev-taux': '25.0%'
  };
  
  for(const [id, value] of Object.entries(elements)) {
    const el = document.getElementById(id);
    if (el) el.textContent = value;
  }
  
  const suggestions = document.getElementById('ia-suggestions');
  if (suggestions) {
    suggestions.innerHTML = `
      <div class="stats-card">
        <h4>üí° Recommandations g√©n√©rales</h4>
        <div class="metric"><span>‚úÖ Augmenter la prospection</span></div>
        <div class="metric"><span>‚úÖ Am√©liorer le closing</span></div>
        <div class="metric"><span>‚úÖ Optimiser les marges</span></div>
      </div>
    `;
  }
}

function updateSaisieFields() {
  console.log('‚úèÔ∏è Mise √† jour champs saisie');
  const sel = document.getElementById('vendeur-select');
  if (!sel) return;
  
  const v = sel.value;
  const d = getDonneesActuelles();
  const marge = d[v]?.margeValeur ?? 2500;
  const objectif = d[v]?.objectif ?? 80000;
  
  const margeInput = document.getElementById('marge-input');
  const objectifInput = document.getElementById('objectif-input');
  
  if (margeInput) margeInput.value = marge;
  if (objectifInput) objectifInput.value = objectif;
}

// === ACTIONS UTILISATEUR ===
function sauvegarderDonnees() {
  console.log('üíæ Sauvegarde donn√©es');
  
  const v = document.getElementById('vendeur-select')?.value;
  const prospects = parseInt(document.getElementById('prospects-input')?.value) || 0;
  const ventes = parseInt(document.getElementById('ventes-input')?.value) || 0;
  const ca = parseInt(document.getElementById('ca-input')?.value) || 0;
  const margeInput = document.getElementById('marge-input')?.value;
  const objectifInput = document.getElementById('objectif-input')?.value;
  
  if (!v) {
    showNotification('Erreur: S√©lectionnez un vendeur', 'warning');
    return;
  }
  
  if (prospects === 0 && ventes === 0 && ca === 0) {
    showNotification('Veuillez saisir au moins une valeur', 'warning');
    return;
  }
  
  if (ventes > prospects && prospects > 0) {
    showNotification('Erreur: Les ventes ne peuvent pas d√©passer les prospects', 'warning');
    return;
  }
  
  const d = getDonneesActuelles();
  d[v].prospects += prospects;
  d[v].ventes += ventes;
  d[v].ca += ca;
  
  if (margeInput !== '') d[v].margeValeur = Math.max(0, parseFloat(margeInput));
  if (objectifInput !== '') d[v].objectif = Math.max(0, parseFloat(objectifInput));
  
  // Reset inputs
  ['prospects-input', 'ventes-input', 'ca-input'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });
  
  showNotification(`Donn√©es sauvegard√©es pour ${v}`);
  updateActiveTab();
}

function exporterDonnees() {
  console.log('üì• Export donn√©es');
  const dataToExport = { 
    donneesParMois, 
    moisActuel, 
    anneeActuelle, 
    dateExport: new Date().toISOString(), 
    version: '2.5-corrige' 
  };
  
  const blob = new Blob([JSON.stringify(dataToExport, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `dashboard-commercial-${anneeActuelle}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  showNotification('üì• Donn√©es export√©es avec succ√®s');
}

function reinitialiserMois() {
  if (confirm(`R√©initialiser les donn√©es de ${MOIS_NOMS[moisActuel]} ${anneeActuelle} ?`)) {
    const key = getMoisKey();
    donneesParMois[key] = vendeurDefaults();
    updateActiveTab();
    showNotification(`Donn√©es de ${MOIS_NOMS[moisActuel]} r√©initialis√©es`, 'warning');
  }
}

function reinitialiserTout() {
  if (confirm('‚ö†Ô∏è ATTENTION : Supprimer TOUTES les donn√©es ?')) {
    donneesParMois = {};
    initialiserDonnees();
    updateActiveTab();
    showNotification('Toutes les donn√©es supprim√©es', 'warning');
  }
}

// === √âV√âNEMENTS ===
function setupEventListeners() {
  console.log('üîß Configuration des √©v√©nements');
  
  // Navigation mois
  const prevBtn = document.getElementById('prev-month');
  const nextBtn = document.getElementById('next-month');
  if (prevBtn) prevBtn.addEventListener('click', () => changerMois(-1));
  if (nextBtn) nextBtn.addEventListener('click', () => changerMois(1));
  
  // Onglets
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', (e) => {
      const tabName = e.target.getAttribute('data-tab');
      if (tabName) showTab(tabName);
    });
  });
  
  // Saisie vendeur
  const vendeurSelect = document.getElementById('vendeur-select');
  if (vendeurSelect) {
    vendeurSelect.addEventListener('change', updateSaisieFields);
  }
  
  // Boutons d'action
  const buttons = {
    'save-btn': sauvegarderDonnees,
    'export-btn': exporterDonnees,
    'reset-month-btn': reinitialiserMois,
    'reset-all-btn': reinitialiserTout,
    'refresh-war-room': updateWarRoom,
    'generate-ia-btn': () => updateIATab()
  };
  
  for(const [id, handler] of Object.entries(buttons)) {
    const btn = document.getElementById(id);
    if (btn) {
      btn.addEventListener('click', handler);
      console.log(`‚úÖ Bouton ${id} configur√©`);
    } else {
      console.warn(`‚ö†Ô∏è Bouton ${id} non trouv√©`);
    }
  }
}

// Auto-actualisation War Room
function demarrerWarRoomAutoRefresh() {
  setInterval(() => {
    const warRoomTab = document.getElementById('warroom');
    if (warRoomTab && warRoomTab.classList.contains('active')) {
      updateWarRoom();
    }
  }, 15000); // 15 secondes
}

// === INITIALISATION ===
function init() {
  console.log('üöÄ Initialisation Dashboard v2.5 Corrig√©');
  
  try {
    initialiserDonnees();
    updateMoisAffichage();
    setupEventListeners();
    updateVueEnsemble();
    updateSaisieFields();
    demarrerWarRoomAutoRefresh();
    
    showNotification('üöÄ Dashboard v2.5 Corrig√© charg√© avec succ√®s !');
    console.log('‚úÖ Initialisation termin√©e');
    
  } catch (error) {
    console.error('‚ùå Erreur initialisation:', error);
    showNotification('‚ùå Erreur lors du chargement', 'warning');
  }
}

// === D√âMARRAGE ===
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}

// Gestion des erreurs globales
window.addEventListener('error', function(e) {
  console.error('‚ùå Erreur globale:', e.error);
  showNotification('‚ö†Ô∏è Une erreur est survenue', 'warning');
});

console.log('üìã Dashboard Commercial Pro v2.5 - Script charg√© et corrig√©');
</script>
</body>
</html>
