const margeMoyenne = totalVentes > 0 ? totalMarge / totalVentes : 0;

           document.getElementById('total-prospects').textContent = totalProspects;
           document.getElementById('total-devis').textContent = totalDevis;
           document.getElementById('total-ventes').textContent = totalVentes;
           document.getElementById('taux-global').textContent = tauxGlobal.toFixed(1) + '%';
           document.getElementById('taux-global').className = 'metric-value ' + (tauxGlobal >= 20 ? 'positive' : 'neutral');
           
           document.getElementById('marge-moyenne').textContent = Math.round(margeMoyenne).toLocaleString() + ' ‚Ç¨';
           document.getElementById('marge-moyenne').className = 'metric-value ' + (margeMoyenne >= MARGE_MINIMUM ? 'positive' : 'negative');

           document.getElementById('ca-realise').textContent = totalCA.toLocaleString() + ' ‚Ç¨';
           document.getElementById('objectif-total').textContent = totalObjectif.toLocaleString() + ' ‚Ç¨';
           document.getElementById('ecart-ca').textContent = (ecartCA >= 0 ? '+' : '') + ecartCA.toLocaleString() + ' ‚Ç¨';
           document.getElementById('ecart-ca').className = 'metric-value ' + (ecartCA >= 0 ? 'positive' : 'negative');

           document.getElementById('progress-ca').style.width = Math.min(100, progressCA) + '%';

           document.getElementById('top-vendeur').textContent = bestVendeur;
           document.getElementById('top-ca').textContent = bestCA.toLocaleString() + ' ‚Ç¨';
           document.getElementById('top-taux').textContent = bestTaux.toFixed(1) + '%';

           // Mettre √† jour les alertes marges
           updateAlertesMarges(vendeursEnAlerteMarge);
           updateChart();
       }

       function updateAlertesMarges(vendeursEnAlerte) {
           const container = document.getElementById('alertes-marges');
           
           if (vendeursEnAlerte.length === 0) {
               container.innerHTML = `
                   <div class="alert alert-success">
                       <strong>‚úÖ Excellent !</strong> Toutes les marges respectent le minimum de ${MARGE_MINIMUM.toLocaleString()}‚Ç¨
                   </div>
               `;
           } else {
               let alertesHTML = `
                   <div class="alert alert-warning">
                       <strong>‚ö†Ô∏è ${vendeursEnAlerte.length} vendeur(s) en dessous de la marge minimum :</strong>
                   </div>
               `;
               
               vendeursEnAlerte.forEach(vendeur => {
                   alertesHTML += `
                       <div class="alert alert-warning" style="margin: 8px 0; padding: 12px;">
                           <strong>${vendeur.nom}</strong> : ${vendeur.marge.toLocaleString()}‚Ç¨ 
                           (-${vendeur.ecart.toLocaleString()}‚Ç¨)
                           <br><small>üí° Action : revoir strat√©gie tarifaire</small>
                       </div>
                   `;
               });
               
               container.innerHTML = alertesHTML;
           }
       }

       function updateChart() {
           const chart = document.getElementById('chart-vendeurs');
           const vendeurs = Object.keys(vendeursData);
           
           let html = '';
           const maxCA = Math.max(...vendeurs.map(v => vendeursData[v].ca));
           
           vendeurs.forEach(vendeur => {
               const data = vendeursData[vendeur];
               const height = maxCA > 0 ? Math.max(20, (data.ca / maxCA) * 200) : 20;
               
               html += `
                   <div class="bar-group">
                       <div class="bar" style="height: ${height}px;">
                           <div class="bar-value">${(data.ca/1000).toFixed(0)}k‚Ç¨</div>
                       </div>
                       <div class="bar-label">${vendeur}</div>
                   </div>
               `;
           });
           
           chart.innerHTML = html;
       }

       function updateVendeurs() {
           const grid = document.getElementById('vendeurs-grid');
           grid.innerHTML = '';

           for (let vendeur in vendeursData) {
               const data = vendeursData[vendeur];
               const taux = data.prospects > 0 ? (data.ventes / data.prospects * 100) : 0;
               const progression = data.objectif > 0 ? (data.ca / data.objectif * 100) : 0;

               const card = document.createElement('div');
               card.className = 'card';
               card.innerHTML = `
                   <h3>üë§ ${vendeur}</h3>
                   <div class="metric">
                       <span>Prospects</span>
                       <span class="metric-value neutral">${data.prospects}</span>
                   </div>
                   <div class="metric">
                       <span>Devis</span>
                       <span class="metric-value neutral">${data.devis}</span>
                   </div>
                   <div class="metric">
                       <span>Ventes</span>
                       <span class="metric-value positive">${data.ventes}</span>
                   </div>
                   <div class="metric">
                       <span>CA</span>
                       <span class="metric-value positive">${data.ca.toLocaleString()} ‚Ç¨</span>
                   </div>
                   <div class="metric">
                       <span>Objectif</span>
                       <span class="metric-value neutral">${data.objectif.toLocaleString()} ‚Ç¨</span>
                   </div>
                   <div class="metric">
                       <span>Taux</span>
                       <span class="metric-value ${taux >= 25 ? 'positive' : 'neutral'}">${taux.toFixed(1)}%</span>
                   </div>
                   <div class="metric">
                       <span>Marge moyenne</span>
                       <span class="metric-value ${data.marge >= MARGE_MINIMUM ? 'positive' : 'negative'}">${data.marge.toLocaleString()} ‚Ç¨</span>
                   </div>
                   <div class="metric">
                       <span>Progression</span>
                       <span class="metric-value ${progression >= 100 ? 'positive' : 'neutral'}">${progression.toFixed(1)}%</span>
                   </div>
                   <div class="progress-bar">
                       <div class="progress-fill" style="width: ${Math.min(100, progression)}%"></div>
                   </div>
                   ${data.marge < MARGE_MINIMUM ? `
                       <div class="alert alert-warning" style="margin-top: 10px;">
                           <strong>‚ö†Ô∏è Marge insuffisante :</strong> ${MARGE_MINIMUM - data.marge}‚Ç¨ en dessous du minimum requis
                       </div>
                   ` : ''}
               `;
               grid.appendChild(card);
           }
       }

       function updateObjectifs() {
           const grid = document.getElementById('objectifs-grid');
           grid.innerHTML = '';

           for (let vendeur in vendeursData) {
               const data = vendeursData[vendeur];
               const progression = data.objectif > 0 ? (data.ca / data.objectif * 100) : 0;
               const ecart = data.ca - data.objectif;

               const card = document.createElement('div');
               card.className = 'card';
               card.innerHTML = `
                   <h3>üéØ ${vendeur}</h3>
                   <div class="metric">
                       <span>Objectif</span>
                       <span class="metric-value neutral">${data.objectif.toLocaleString()} ‚Ç¨</span>
                   </div>
                   <div class="metric">
                       <span>R√©alis√©</span>
                       <span class="metric-value positive">${data.ca.toLocaleString()} ‚Ç¨</span>
                   </div>
                   <div class="metric">
                       <span>√âcart</span>
                       <span class="metric-value ${ecart >= 0 ? 'positive' : 'negative'}">${ecart >= 0 ? '+' : ''}${ecart.toLocaleString()} ‚Ç¨</span>
                   </div>
                   <div class="metric">
                       <span>Progression</span>
                       <span class="metric-value ${progression >= 100 ? 'positive' : 'neutral'}">${progression.toFixed(1)}%</span>
                   </div>
                   <div class="progress-bar">
                       <div class="progress-fill" style="width: ${Math.min(100, progression)}%"></div>
                   </div>
                   <div style="margin-top: 15px; padding: 10px; background: #f7fafc; border-radius: 8px;">
                       <strong>Primes :</strong><br>
                       <small style="color: ${data.ca >= 80000 ? '#38a169' : '#a0aec0'};">‚úì 80k‚Ç¨ ‚Üí 200‚Ç¨</small><br>
                       <small style="color: ${data.ca >= 100000 ? '#38a169' : '#a0aec0'};">‚úì 100k‚Ç¨ ‚Üí 500‚Ç¨</small><br>
                       <small style="color: ${data.ca >= 120000 ? '#38a169' : '#a0aec0'};">‚úì 120k‚Ç¨ ‚Üí 750‚Ç¨</small>
                   </div>
               `;
               grid.appendChild(card);
           }
       }

       function updateHistorique() {
           updateChartHistorique();
           updateTableauHistorique();
       }

       function updateChartHistorique() {
           const chart = document.getElementById('chart-historique');
           const mois = Object.keys(donneesMenuelles).sort();
           
           const totauxParMois = mois.map(mois => {
               let totalCA = 0;
               for (let vendeur in donneesMenuelles[mois]) {
                   totalCA += donneesMenuelles[mois][vendeur].ca;
               }
               return { mois, ca: totalCA };
           });
           
           const maxCA = Math.max(...totauxParMois.map(t => t.ca));
           
           let html = '';
           totauxParMois.forEach(({mois, ca}) => {
               const height = maxCA > 0 ? Math.max(30, (ca / maxCA) * 200) : 30;
               const monthName = getMonthName(mois).split(' ')[0].substring(0, 3);
               const isCurrentMonth = mois === moisActuel;
               
               html += `
                   <div class="bar-group">
                       <div class="bar" style="
                           height: ${height}px; 
                           background: ${isCurrentMonth ? '#667eea' : '#48bb78'};
                           ${isCurrentMonth ? 'box-shadow: 0 0 10px rgba(102, 126, 234, 0.5);' : ''}
                       ">
                           <div class="bar-value">${(ca/1000).toFixed(0)}k‚Ç¨</div>
                       </div>
                       <div class="bar-label" style="font-weight: ${isCurrentMonth ? 'bold' : 'normal'};">${monthName}</div>
                   </div>
               `;
           });
           
           chart.innerHTML = html;
       }

       function updateTableauHistorique() {
           const tbody = document.getElementById('tableau-historique');
           const mois = Object.keys(donneesMenuelles).sort();
           
           tbody.innerHTML = mois.map(mois => {
               let totalProspects = 0, totalDevis = 0, totalVentes = 0, totalCA = 0, totalObjectif = 0;
               
               for (let vendeur in donneesMenuelles[mois]) {
                   const data = donneesMenuelles[mois][vendeur];
                   totalProspects += data.prospects;
                   totalDevis += data.devis;
                   totalVentes += data.ventes;
                   totalCA += data.ca;
                   totalObjectif += data.objectif;
               }
               
               const progression = totalObjectif > 0 ? (totalCA / totalObjectif * 100) : 0;
               const isCurrentMonth = mois === moisActuel;
               
               return `
                   <tr style="background: ${isCurrentMonth ? 'rgba(102, 126, 234, 0.1)' : 'white'}; font-weight: ${isCurrentMonth ? 'bold' : 'normal'};">
                       <td>${getMonthName(mois)}</td>
                       <td>${totalProspects}</td>
                       <td>${totalDevis}</td>
                       <td>${totalVentes}</td>
                       <td>${totalCA.toLocaleString()}‚Ç¨</td>
                       <td>${totalObjectif.toLocaleString()}‚Ç¨</td>
                       <td style="color: ${progression >= 100 ? '#38a169' : progression >= 80 ? '#ed8936' : '#e53e3e'};">${progression.toFixed(1)}%</td>
                   </tr>
               `;
           }).join('');
       }

       // === SAISIE ET ADMINISTRATION ===
       function sauvegarderDonnees() {
           const vendeur = document.getElementById('vendeur-select').value;
           const prospects = parseInt(document.getElementById('prospects-input').value) || 0;
           const devis = parseInt(document.getElementById('devis-input').value) || 0;
           const ventes = parseInt(document.getElementById('ventes-input').value) || 0;
           const ca = parseInt(document.getElementById('ca-input').value) || 0;
           const marge = parseInt(document.getElementById('marge-input').value) || 0;

           if (prospects === 0 && devis === 0 && ventes === 0 && ca === 0) {
               showNotification('Veuillez saisir au moins une valeur', 'warning');
               return;
           }

           if (ventes > devis && devis > 0) {
               showNotification('Erreur : les ventes ne peuvent pas d√©passer les devis', 'warning');
               return;
           }

           if (devis > prospects && prospects > 0) {
               showNotification('Erreur : les devis ne peuvent pas d√©passer les prospects', 'warning');
               return;
           }

           // Mise √† jour des donn√©es
           const data = vendeursData[vendeur];
           const ventesActuelles = data.ventes;
           const margeActuelle = data.marge;
           
           data.prospects += prospects;
           data.devis += devis;
           data.ventes += ventes;
           data.ca += ca;
           
           // Calcul de la nouvelle marge moyenne pond√©r√©e
           if (ventes > 0 && marge > 0) {
               const margeTotal = (margeActuelle * ventesActuelles) + (marge * ventes);
               data.marge = Math.round(margeTotal / (ventesActuelles + ventes));
           }

           // Sauvegarder dans l'historique
           donneesMenuelles[moisActuel] = JSON.parse(JSON.stringify(vendeursData));

           // R√©initialiser le formulaire
           document.getElementById('prospects-input').value = '';
           document.getElementById('devis-input').value = '';
           document.getElementById('ventes-input').value = '';
           document.getElementById('ca-input').value = '';
           document.getElementById('marge-input').value = '';

           showNotification(`Donn√©es sauvegard√©es pour ${vendeur}`);
           updateVueEnsemble();
       }

       function exporterDonnees() {
           const dataToExport = {
               donneesMenuelles: donneesMenuelles,
               moisActuel: moisActuel,
               dateExport: new Date().toISOString(),
               version: "1.0"
           };
           
           const blob = new Blob([JSON.stringify(dataToExport, null, 2)], {type: 'application/json'});
           const url = URL.createObjectURL(blob);
           const a = document.createElement('a');
           a.href = url;
           a.download = `dashboard-commercial-${new Date().getFullYear()}.json`;
           document.body.appendChild(a);
           a.click();
           document.body.removeChild(a);
           URL.revokeObjectURL(url);
           
           showNotification('Donn√©es export√©es avec succ√®s !');
       }

       function reinitialiser() {
           if (confirm('√ätes-vous s√ªr de vouloir r√©initialiser toutes les donn√©es ?')) {
               // R√©initialiser le mois actuel uniquement
               donneesMenuelles[moisActuel] = {
                   'Vincent': { prospects: 0, devis: 0, ventes: 0, ca: 0, objectif: 80000, marge: 2000 },
                   'Raphael': { prospects: 0, devis: 0, ventes: 0, ca: 0, objectif: 100000, marge: 2000 },
                   'L√©o': { prospects: 0, devis: 0, ventes: 0, ca: 0, objectif: 75000, marge: 2000 },
                   'Pablo': { prospects: 0, devis: 0, ventes: 0, ca: 0, objectif: 90000, marge: 2000 },
                   'Nathan': { prospects: 0, devis: 0, ventes: 0, ca: 0, objectif: 85000, marge: 2000 }
               };
               vendeursData = JSON.parse(JSON.stringify(donneesMenuelles[moisActuel]));
               updateVueEnsemble();
               showNotification(`Donn√©es du mois r√©initialis√©es`, 'warning');
           }
       }

       // === INITIALISATION ===
       document.addEventListener('DOMContentLoaded', function() {
           // Charger les donn√©es du mois actuel
           vendeursData = JSON.parse(JSON.stringify(donneesMenuelles[moisActuel]));
           
           // Mise √† jour initiale
           updateVueEnsemble();
           
           // Message de bienvenue
           setTimeout(() => {
               showNotification('Dashboard charg√© avec succ√®s ! üöÄ');
           }, 1000);
       });
   </script>
</body>
</html>
