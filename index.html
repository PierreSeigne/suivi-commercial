<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Commercial Pro ‚Äî Vercel (JSON backend)</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
    .container { max-width: 1400px; margin: 0 auto; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
    h1 { color: white; font-size: 2.3rem; font-weight: 400; }
    .month-selector { display: flex; align-items: center; background: rgba(255, 255, 255, 0.1); border-radius: 15px; padding: 10px; backdrop-filter: blur(10px); }
    .month-btn { background: transparent; border: none; color: white; font-size: 24px; cursor: pointer; padding: 10px; border-radius: 8px; transition: all 0.3s; }
    .month-btn:hover { background: rgba(255, 255, 255, 0.1); transform: scale(1.1); }
    .current-month { color: white; font-size: 18px; font-weight: 500; margin: 0 20px; min-width: 150px; text-align: center; }
    .tabs { display: flex; background: rgba(255, 255, 255, 0.1); border-radius: 15px; padding: 5px; margin-bottom: 30px; backdrop-filter: blur(10px); overflow-x: auto; }
    .tab { flex: 1; padding: 15px; text-align: center; background: transparent; border: none; color: rgba(255,255,255,0.8); cursor: pointer; border-radius: 10px; transition: all 0.3s; font-size: 16px; white-space: nowrap; }
    .tab.active { background: rgba(255, 255, 255, 0.2); color: white; transform: translateY(-2px); box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .overview-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .overview-card { background: rgba(255,255,255,0.95); border-radius: 15px; padding: 25px; text-align: center; box-shadow: 0 8px 32px rgba(0,0,0,0.1); backdrop-filter: blur(10px); position: relative; overflow: hidden; }
    .overview-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(45deg, #667eea, #764ba2); }
    .overview-card h3 { color: #4a5568; font-size: 14px; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
    .overview-card .value { font-size: 2rem; font-weight: bold; margin-bottom: 5px; }
    .overview-card .trend { font-size: 12px; display: flex; align-items: center; justify-content: center; gap: 5px; }
    .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .card { background: rgba(255,255,255,0.95); border-radius: 15px; padding: 25px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); backdrop-filter: blur(10px); transition: transform 0.3s; }
    .card:hover { transform: translateY(-5px); }
    .chart-container { background: rgba(255,255,255,0.95); border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); }
    .chart { display: flex; align-items: end; gap: 15px; height: 200px; padding: 20px 0; }
    .bar-group { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 10px; }
    .bar { width: 100%; max-width: 60px; background: linear-gradient(to top, #667eea, #764ba2); border-radius: 4px 4px 0 0; position: relative; transition: all 0.3s; cursor: pointer; }
    .bar:hover { transform: scaleY(1.05); box-shadow: 0 4px 20px rgba(102,126,234,0.3); }
    .bar-value { position: absolute; top: -25px; left: 50%; transform: translateX(-50%); font-size: 12px; font-weight: bold; color: #4a5568; white-space: nowrap; }
    .bar-label { font-size: 12px; color: #4a5568; text-align: center; font-weight: 500; }
    .metric { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #e2e8f0; }
    .metric:last-child { border-bottom: none; }
    .metric-value { font-weight: bold; font-size: 1.1rem; }
    .positive { color: #38a169; } .negative { color: #e53e3e; } .neutral { color: #4a5568; }
    .progress-bar { width: 100%; height: 10px; background: #e2e8f0; border-radius: 5px; margin-top: 10px; overflow: hidden; }
    .progress-fill { height: 100%; border-radius: 5px; transition: all 0.8s ease; background: linear-gradient(45deg, #38a169, #48bb78); }
    .input-group { margin-bottom: 20px; }
    .input-group label { display: block; margin-bottom: 8px; color: #4a5568; font-weight: 500; }
    .input-group input, .input-group select { width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; transition: border-color 0.3s; }
    .input-group input:focus, .input-group select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }
    .btn { background: linear-gradient(45deg, #667eea, #764ba2); color: white; border: none; padding: 14px 28px; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: 500; margin: 5px; transition: all 0.3s; box-shadow: 0 4px 15px rgba(102,126,234,0.3); }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(102,126,234,0.4); }
    .btn-warning { background: linear-gradient(45deg, #ed8936, #dd6b20); box-shadow: 0 4px 15px rgba(237,137,54,0.3); }
    .btn-secondary { background: linear-gradient(45deg, #718096, #4a5568); box-shadow: 0 4px 15px rgba(113,128,150,0.3); }
    .alert { padding: 20px; border-radius: 10px; margin: 15px 0; border-left: 4px solid; }
    .alert-success { background: linear-gradient(45deg, #c6f6d5, #9ae6b4); color: #22543d; border-color: #38a169; }
    .alert-warning { background: linear-gradient(45deg, #fefcbf, #faf089); color: #744210; border-color: #ed8936; }
    .notification { position: fixed; top: 20px; right: 20px; padding: 15px 20px; background: linear-gradient(45deg, #38a169, #48bb78); color: white; border-radius: 10px; z-index: 1000; transform: translateX(400px); transition: transform 0.3s; box-shadow: 0 8px 25px rgba(56,161,105,0.3); }
    .notification.show { transform: translateX(0); }
    .notification.warning { background: linear-gradient(45deg, #ed8936, #dd6b20); box-shadow: 0 8px 25px rgba(237,137,54,0.3); }
    .comparison-section { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px; }
    .stats-card { background: rgba(255,255,255,0.95); border-radius: 15px; padding: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); }
    .evolution-indicator { display: inline-flex; align-items: center; gap: 5px; font-size: 14px; padding: 4px 8px; border-radius: 20px; font-weight: 500; }
    .evolution-up { background: #c6f6d5; color: #22543d; }
    .evolution-down { background: #fed7d7; color: #742a2a; }
    .evolution-equal { background: #e2e8f0; color: #4a5568; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px 10px; border-bottom: 1px solid #e2e8f0; text-align: left; }
    th { font-size: 12px; text-transform: uppercase; letter-spacing: 0.8px; color: #4a5568; }
    tr:hover td { background: rgba(102,126,234,0.06); }
    @media (max-width: 768px) {
      .header { flex-direction: column; gap: 20px; }
      .comparison-section { grid-template-columns: 1fr; }
      .overview-grid { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
      .cards-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>üìä Dashboard Commercial - CVL</h1>
    <div class="month-selector">
      <button class="month-btn" onclick="changerMois(-1)">‚Äπ</button>
      <span class="current-month" id="current-month"></span>
      <button class="month-btn" onclick="changerMois(1)">‚Ä∫</button>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" onclick="showTab(event, 'vue-ensemble')">üìà Vue d'ensemble</button>
    <button class="tab" onclick="showTab(event, 'vendeurs')">üë• Vendeurs</button>
    <button class="tab" onclick="showTab(event, 'vue-annuelle')">üóìÔ∏è Vue Annuelle</button>
    <button class="tab" onclick="showTab(event, 'comparatif')">üìä Comparatif</button>
    <button class="tab" onclick="showTab(event, 'saisie')">‚úèÔ∏è Saisie</button>
    <button class="tab" onclick="showTab(event, 'ia')">ü§ñ Pr√©diction IA</button>
  </div>

  <!-- Vue d'ensemble -->
  <div id="vue-ensemble" class="tab-content active">
    <div class="overview-grid">
      <div class="overview-card"><h3>Total Rendez-vous</h3><div class="value neutral" id="total-prospects">0</div><div class="trend" id="trend-prospects"></div></div>
      <div class="overview-card"><h3>Total Ventes</h3><div class="value positive" id="total-ventes">0</div><div class="trend" id="trend-ventes"></div></div>
      <div class="overview-card"><h3>Taux Global</h3><div class="value" id="taux-global">0%</div><div class="trend" id="trend-taux"></div></div>
      <div class="overview-card"><h3>CA R√©alis√©</h3><div class="value positive" id="ca-realise">0 ‚Ç¨</div><div class="trend" id="trend-ca"></div></div>
      <div class="overview-card"><h3>Objectif Total</h3><div class="value neutral" id="objectif-total">0 ‚Ç¨</div></div>
      <div class="overview-card"><h3>Progression</h3><div class="value" id="progression-total">0%</div><div class="progress-bar"><div class="progress-fill" id="progress-ca" style="width: 0%"></div></div></div>
    </div>
    <div class="chart-container"><h3 style="margin-bottom: 20px;">üìä CA par vendeur</h3><div class="chart" id="chart-vendeurs"></div></div>
    <div class="card">
      <h3>üèÜ Meilleur Vendeur du Mois</h3>
      <div class="metric"><span>Nom</span><span class="metric-value positive" id="top-vendeur">-</span></div>
      <div class="metric"><span>CA</span><span class="metric-value positive" id="top-ca">0 ‚Ç¨</span></div>
      <div class="metric"><span>Taux de conversion</span><span class="metric-value positive" id="top-taux">0%</span></div>
      <div class="metric"><span>Progression objectif</span><span class="metric-value positive" id="top-progression">0%</span></div>
    </div>
    <div id="alertes-marges"></div>
  </div>

  <!-- Vendeurs -->
  <div id="vendeurs" class="tab-content"><div class="cards-grid" id="vendeurs-grid"></div></div>

  <!-- Vue Annuelle -->
  <div id="vue-annuelle" class="tab-content">
    <div class="overview-grid">
      <div class="overview-card"><h3>CA Annuel</h3><div class="value positive" id="ca-annuel">0 ‚Ç¨</div><div class="trend" id="trend-ca-annuel"></div></div>
      <div class="overview-card"><h3>Objectif Annuel</h3><div class="value neutral" id="objectif-annuel">0 ‚Ç¨</div></div>
      <div class="overview-card"><h3>Progression</h3><div class="value" id="progression-annuelle">0%</div><div class="progress-bar"><div class="progress-fill" id="progress-annuel" style="width: 0%"></div></div></div>
      <div class="overview-card"><h3>Ventes Totales</h3><div class="value positive" id="ventes-annuelles">0</div></div>
      <div class="overview-card"><h3>Rendez-vous Totaux</h3><div class="value neutral" id="prospects-annuels">0</div></div>
      <div class="overview-card"><h3>Taux Global Annuel</h3><div class="value" id="taux-annuel">0%</div></div>
    </div>
    <div class="chart-container">
      <h3 style="margin-bottom: 20px;">üìà √âvolution mensuelle du CA <span id="annee-actuelle-1"></span></h3>
      <div class="chart" id="chart-annuel" style="height: 250px;"></div>
    </div>
    <div class="comparison-section">
      <div class="stats-card"><h3>üèÜ Classement annuel des vendeurs</h3><div id="classement-annuel"></div></div>
      <div class="stats-card"><h3>üìä Statistiques par trimestre</h3><div id="stats-trimestrielles"></div></div>
    </div>
    <div class="cards-grid">
      <div class="card"><h3>üéØ Performance annuelle par vendeur</h3><div id="performance-annuelle"></div></div>
      <div class="card"><h3>üìà Meilleur/Pire mois de l'ann√©e</h3><div id="analyse-mois"></div></div>
    </div>
    <div class="chart-container">
      <h3 style="margin-bottom: 20px;">üìä R√©partition du CA par vendeur (<span id="annee-actuelle-2"></span>)</h3>
      <div style="display:flex; justify-content:center; align-items:center; height:200px;">
        <canvas id="chart-repartition" width="300" height="300"></canvas>
      </div>
    </div>
  </div>

  <!-- Comparatif -->
  <div id="comparatif" class="tab-content">
    <div class="comparison-section">
      <div class="stats-card"><h3>üìà √âvolution par rapport au mois pr√©c√©dent</h3><div id="evolution-content"></div></div>
      <div class="stats-card"><h3>üéØ Performance vs Objectifs</h3><div id="performance-content"></div></div>
    </div>
    <div class="chart-container"><h3 style="margin-bottom: 20px;">üìä √âvolution du CA sur 6 mois</h3><div class="chart" id="chart-evolution"></div></div>
  </div>

  <!-- Saisie -->
  <div id="saisie" class="tab-content">
    <div class="cards-grid">
      <div class="card">
        <h3>üìù Saisie des donn√©es</h3>
        <div class="input-group">
          <label for="vendeur-select">Vendeur</label>
          <select id="vendeur-select" onchange="updateSaisieFields()">
            <option value="Vincent">Vincent</option>
            <option value="Raphael">Raphael</option>
            <option value="L√©o">L√©o</option>
            <option value="Pablo">Pablo</option>
            <option value="Nathan">Nathan</option>
          </select>
        </div>
        <div class="input-group"><label for="prospects-input">Rendez-vous</label><input type="number" id="prospects-input" placeholder="Nombre de prospects" /></div>
        <div class="input-group"><label for="ventes-input">Ventes</label><input type="number" id="ventes-input" placeholder="Nombre de ventes" /></div>
        <div class="input-group"><label for="ca-input">CA (‚Ç¨)</label><input type="number" id="ca-input" placeholder="Chiffre d'affaires" /></div>
        <div class="input-group"><label for="marge-input">Marge moyenne / vente (‚Ç¨)</label><input type="number" id="marge-input" placeholder="Ex: 2500" min="0" step="50" /></div>
        <div class="input-group"><label for="objectif-input">Objectif mensuel (‚Ç¨)</label><input type="number" id="objectif-input" placeholder="Ex: 80000" min="0" step="1000" /></div>
        <button class="btn" onclick="sauvegarderDonnees()">üíæ Sauvegarder</button>
      </div>

      <div class="card">
        <h3>‚öôÔ∏è Administration</h3>
        <button class="btn btn-secondary" onclick="exporterDonnees()">üì• Exporter donn√©es</button>
        <button class="btn btn-warning" onclick="reinitialiserMois()">üîÑ R√©initialiser mois</button>
        <button class="btn btn-warning" onclick="reinitialiserTout()">üóëÔ∏è Tout effacer</button>

        <div style="margin-top: 20px; padding: 15px; background: #f7fafc; border-radius: 8px;">
          <h4 style="margin-bottom: 10px;">üìã Actions rapides :</h4>
          <button class="btn btn-secondary" onclick="genererDonneesDemonstration()">üé≠ Donn√©es d√©mo</button>
        </div>

        <div style="margin-top: 20px; padding: 15px; background: #f0f5ff; border-radius: 8px;">
          <div style="display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; background:rgba(66,133,244,.12); color:#1a73e8; font-weight:600; font-size:13px;">üîó Sauvegarde serveur (Vercel)</div>
          <div class="small" style="margin:6px 0 12px;">Les donn√©es sont partag√©es via un JSON sur Vercel (pas de Google Sheets).</div>
          <button class="btn" onclick="chargerDepuisServeur()">‚¨áÔ∏è Charger depuis serveur</button>
          <button class="btn" onclick="sauvegarderVersServeur()">‚¨ÜÔ∏è Sauvegarder vers serveur</button>
          <div id="server-status" class="small" style="margin-top:10px;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- IA -->
  <div id="ia" class="tab-content">
    <div class="overview-grid">
      <div class="overview-card"><h3>Pr√©vision fin de mois (CA)</h3><div class="value" id="ia-prev-ca">0 ‚Ç¨</div><div class="trend" id="ia-prev-trend"></div></div>
      <div class="overview-card"><h3>Pr√©vision Ventes</h3><div class="value" id="ia-prev-ventes">0</div><div class="trend" id="ia-prev-ventes-trend"></div></div>
      <div class="overview-card"><h3>Taux conversion pr√©visionnel</h3><div class="value" id="ia-prev-taux">0%</div></div>
      <div class="overview-card">
        <h3>Param√®tres seuil</h3>
        <div class="input-group" style="margin-top:10px;">
          <label for="seuil-marge">Seuil minimal / vente (‚Ç¨)</label>
          <input type="number" id="seuil-marge" value="2000" min="0" oninput="updateIATab()" />
        </div>
        <div style="font-size:12px; color:#4a5568;">‚ÑπÔ∏è Le calcul des marges utilise la <strong>marge moyenne / vente (‚Ç¨)</strong> saisie dans l'onglet <em>Saisie</em>.</div>
      </div>
    </div>

    <div class="cards-grid">
      <div class="card">
        <h3>üß† Recommandations pour am√©liorer le taux de transformation</h3>
        <div id="ia-suggestions"></div>
        <button class="btn" style="margin-top:10px;" onclick="updateIATab()">üîÅ G√©n√©rer recommandations</button>
      </div>
      <div class="card">
        <h3>üí∂ Marges minimales par vendeur (‚â• <span id="label-seuil-marge">2000</span> ‚Ç¨)</h3>
        <div class="stats-card" style="margin-top:10px;">
          <table>
            <thead>
              <tr><th>Vendeur</th><th>Ventes</th><th>CA</th><th>Marge moyenne</th><th>Marge totale</th><th>Statut</th></tr>
            </thead>
            <tbody id="ia-marges"></tbody>
          </table>
        </div>
        <div id="ia-messages" style="margin-top:10px;"></div>
      </div>
    </div>

    <div class="chart-container">
      <h3 style="margin-bottom: 20px;">üìä CA pr√©visionnel vs R√©alis√© (6 derniers mois)</h3>
      <div class="chart" id="ia-chart-prev"></div>
    </div>
  </div>
</div>

<script>
function showNotification(message, type='success'){
  const n=document.createElement('div'); n.className=`notification ${type}`; n.textContent=message; document.body.appendChild(n);
  setTimeout(()=>n.classList.add('show'),100); setTimeout(()=>{ n.classList.remove('show'); setTimeout(()=>document.body.removeChild(n),300); },3000);
}

const MOIS_NOMS = ['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'];
let moisActuel = new Date().getMonth();
let anneeActuelle = new Date().getFullYear();
let donneesParMois = {};

function vendeurDefaults(){
  return {
    'Vincent': { prospects:0, ventes:0, ca:0, objectif:80000, margeValeur:2500 },
    'Raphael': { prospects:0, ventes:0, ca:0, objectif:100000, margeValeur:2600 },
    'L√©o':     { prospects:0, ventes:0, ca:0, objectif:75000, margeValeur:2200 },
    'Pablo':   { prospects:0, ventes:0, ca:0, objectif:90000, margeValeur:2400 },
    'Nathan':  { prospects:0, ventes:0, ca:0, objectif:85000, margeValeur:2300 }
  };
}

function getMoisKey(mois=moisActuel, annee=anneeActuelle){ return `${annee}-${mois}`; }
function getDonneesActuelles(){ return donneesParMois[getMoisKey()]; }

function initialiserDonnees(){
  for(let mois=0; mois<12; mois++){
    const key = `${anneeActuelle}-${mois}`;
    if(!donneesParMois[key]){
      donneesParMois[key] = vendeurDefaults();
    }else{
      for(const v in donneesParMois[key]){
        const x = donneesParMois[key][v];
        if(x.margeValeur === undefined){
          const panier = x.ventes>0 ? x.ca/x.ventes : 10000;
          donneesParMois[key][v].margeValeur = Math.max(1000, Math.round(panier*0.25));
        }
        if(x.objectif === undefined){ donneesParMois[key][v].objectif = 80000; }
      }
    }
  }
}

function changerMois(direction){
  moisActuel += direction;
  if(moisActuel<0){ moisActuel=11; anneeActuelle--; }
  else if(moisActuel>11){ moisActuel=0; anneeActuelle++; }
  const key = getMoisKey();
  if(!donneesParMois[key]){ donneesParMois[key] = vendeurDefaults(); }
  updateMoisAffichage();
  const activeTab = document.querySelector('.tab.active');
  if(activeTab){
    const tabName = activeTab.getAttribute('onclick').match(/'(.*?)'/)[1];
    updateTabContent(tabName);
  }
  updateSaisieFields();
}

function updateMoisAffichage(){
  document.getElementById('current-month').textContent = `${MOIS_NOMS[moisActuel]} ${anneeActuelle}`;
  const yEls = [document.getElementById('annee-actuelle-1'), document.getElementById('annee-actuelle-2')];
  yEls.forEach(el=>{ if(el) el.textContent = anneeActuelle; });
}

function showTab(e, tabName){
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById(tabName).classList.add('active');
  if(e && e.target) e.target.classList.add('active');
  updateTabContent(tabName);
}

function updateTabContent(tabName){
  switch(tabName){
    case 'vue-ensemble': updateVueEnsemble(); break;
    case 'vendeurs': updateVendeurs(); break;
    case 'vue-annuelle': updateVueAnnuelle(); break;
    case 'comparatif': updateComparatif(); break;
    case 'ia': updateIATab(); break;
    case 'saisie': updateSaisieFields(); break;
  }
}

function calculerTendance(valeurActuelle, valeurPrecedente){
  if(valeurPrecedente===0) return { type:'equal', text:'Nouveau' };
  const evolution = ((valeurActuelle - valeurPrecedente) / valeurPrecedente) * 100;
  if(evolution>0) return { type:'up', text:`+${evolution.toFixed(1)}%` };
  if(evolution<0) return { type:'down', text:`${evolution.toFixed(1)}%` };
  return { type:'equal', text:'0%' };
}
function afficherTendance(elementId, valeurActuelle, valeurPrecedente){
  const el = document.getElementById(elementId);
  const t = calculerTendance(valeurActuelle, valeurPrecedente);
  el.innerHTML = `<span class="evolution-indicator evolution-${t.type}">${t.type==='up'?'‚Üó':t.type==='down'?'‚Üò':'‚Üí'} ${t.text}</span>`;
}

function updateVueEnsemble(){
  const d = getDonneesActuelles();
  const moisPrec = moisActuel===0?11:moisActuel-1; const anPrec = moisActuel===0?anneeActuelle-1:anneeActuelle;
  const dPrec = donneesParMois[`${anPrec}-${moisPrec}`] || {};
  let totalProspects=0,totalVentes=0,totalCA=0,totalObjectif=0; let prevProspects=0,prevVentes=0,prevCA=0; let bestVendeur='',bestCA=0,bestTaux=0,bestProgression=0;
  for(const v in d){ const x=d[v]; totalProspects+=x.prospects; totalVentes+=x.ventes; totalCA+=x.ca; totalObjectif+=x.objectif; const taux=x.prospects>0?(x.ventes/x.prospects*100):0; const prog=x.objectif>0?(x.ca/x.objectif*100):0; if(x.ca>bestCA){ bestCA=x.ca; bestVendeur=v; bestTaux=taux; bestProgression=prog; } }
  for(const v in dPrec){ const x=dPrec[v]||{prospects:0,ventes:0,ca:0}; prevProspects+=x.prospects; prevVentes+=x.ventes; prevCA+=x.ca; }
  const tauxGlobal = totalProspects>0 ? (totalVentes/totalProspects*100) : 0;
  const progressionCA = totalObjectif>0 ? (totalCA/totalObjectif*100) : 0;
  const prevTaux = prevProspects>0 ? (prevVentes/prevProspects*100) : 0;
  document.getElementById('total-prospects').textContent = totalProspects;
  document.getElementById('total-ventes').textContent = totalVentes;
  document.getElementById('taux-global').textContent = tauxGlobal.toFixed(1)+'%';
  document.getElementById('taux-global').className = 'value '+(tauxGlobal>=20?'positive':'neutral');
  document.getElementById('ca-realise').textContent = totalCA.toLocaleString()+' ‚Ç¨';
  document.getElementById('objectif-total').textContent = totalObjectif.toLocaleString()+' ‚Ç¨';
  document.getElementById('progression-total').textContent = progressionCA.toFixed(1)+'%';
  document.getElementById('progression-total').className = 'value '+(progressionCA>=100?'positive':'neutral');
  document.getElementById('progress-ca').style.width = Math.min(100, progressionCA)+'%';
  document.getElementById('top-vendeur').textContent = bestVendeur||'-';
  document.getElementById('top-ca').textContent = bestCA.toLocaleString()+' ‚Ç¨';
  document.getElementById('top-taux').textContent = bestTaux.toFixed(1)+'%';
  document.getElementById('top-progression').textContent = bestProgression.toFixed(1)+'%';
  afficherTendance('trend-prospects', totalProspects, prevProspects);
  afficherTendance('trend-ventes', totalVentes, prevVentes);
  afficherTendance('trend-taux', tauxGlobal, prevTaux);
  afficherTendance('trend-ca', totalCA, prevCA);
  updateChart();
  updateAlertes();
}

function updateChart(){
  const chart = document.getElementById('chart-vendeurs');
  const d = getDonneesActuelles();
  const vendeurs = Object.keys(d);
  let html='';
  const maxCA = Math.max(...vendeurs.map(v=>d[v].ca));
  vendeurs.forEach(v=>{
    const x=d[v]; const height = maxCA>0?Math.max(30,(x.ca/maxCA)*160):30;
    html += `<div class="bar-group"><div class="bar" style="height:${height}px;"><div class="bar-value">${(x.ca/1000).toFixed(0)}k‚Ç¨</div></div><div class="bar-label">${v}</div></div>`;
  });
  chart.innerHTML = html;
}

function updateAlertes(){
  const container = document.getElementById('alertes-marges');
  const d = getDonneesActuelles();
  let alertes=[];
  for(const v in d){ const x=d[v]; const prog=x.objectif>0?(x.ca/x.objectif*100):0; if(prog<50){ alertes.push(`${v} : ${prog.toFixed(1)}% de son objectif`); } }
  container.innerHTML = alertes.length===0 ? `<div class="alert alert-success"><strong>‚úÖ Excellent !</strong> Tous les vendeurs progressent bien vers leurs objectifs.</div>` : `<div class="alert alert-warning"><strong>‚ö†Ô∏è ${alertes.length} vendeur(s) en retard sur objectifs :</strong><br>${alertes.join('<br>')}</div>`;
}

function updateVendeurs(){
  const grid = document.getElementById('vendeurs-grid');
  const d = getDonneesActuelles(); grid.innerHTML='';
  for(const v in d){ const x=d[v]; const taux=x.prospects>0?(x.ventes/x.prospects*100):0; const prog=x.objectif>0?(x.ca/x.objectif*100):0; const ecart=x.ca-x.objectif;
    const card=document.createElement('div'); card.className='card'; card.innerHTML = `
      <h3>üë§ ${v}</h3>
      <div class="metric"><span>Prospects</span><span class="metric-value neutral">${x.prospects}</span></div>
      <div class="metric"><span>Ventes</span><span class="metric-value positive">${x.ventes}</span></div>
      <div class="metric"><span>CA</span><span class="metric-value positive">${x.ca.toLocaleString()} ‚Ç¨</span></div>
      <div class="metric"><span>Objectif</span><span class="metric-value neutral">${x.objectif.toLocaleString()} ‚Ç¨</span></div>
      <div class="metric"><span>Marge moyenne / vente</span><span class="metric-value neutral">${(x.margeValeur??2500).toLocaleString()} ‚Ç¨</span></div>
      <div class="metric"><span>√âcart objectif</span><span class="metric-value ${ecart>=0?'positive':'negative'}">${ecart>=0?'+':''}${ecart.toLocaleString()} ‚Ç¨</span></div>
      <div class="metric"><span>Taux conversion</span><span class="metric-value ${taux>=25?'positive':'neutral'}">${taux.toFixed(1)}%</span></div>
      <div class="metric"><span>Progression</span><span class="metric-value ${prog>=100?'positive':'neutral'}">${prog.toFixed(1)}%</span></div>
      <div class="progress-bar"><div class="progress-fill" style="width:${Math.min(100,prog)}%"></div></div>
      ${prog<50?`<div class="alert alert-warning" style="margin-top:15px;"><strong>‚ö†Ô∏è Attention :</strong> Progression faible (${prog.toFixed(1)}%)</div>`:''}
    `; grid.appendChild(card);
  }
}

function updateComparatif(){ updateEvolution(); updatePerformance(); updateChartEvolution(); }
function updateEvolution(){
  const container = document.getElementById('evolution-content');
  const d = getDonneesActuelles();
  const moisPrec = moisActuel===0?11:moisActuel-1; const anPrec = moisActuel===0?anneeActuelle-1:anneeActuelle; const dPrec = donneesParMois[`${anPrec}-${moisPrec}`]||{};
  let html=''; let totalCA=0,prevCA=0,totalVentes=0,prevVentes=0;
  for(const v in d){ totalCA+=d[v].ca; totalVentes+=d[v].ventes; }
  for(const v in dPrec){ prevCA+=dPrec[v]?.ca||0; prevVentes+=dPrec[v]?.ventes||0; }
  const evoCA=calculerTendance(totalCA,prevCA); const evoV=calculerTendance(totalVentes,prevVentes);
  html += `<div class="metric"><span>CA Total</span><span class="evolution-indicator evolution-${evoCA.type}">${evoCA.type==='up'?'‚Üó':evoCA.type==='down'?'‚Üò':'‚Üí'} ${evoCA.text}</span></div>`;
  html += `<div class="metric"><span>Ventes Totales</span><span class="evolution-indicator evolution-${evoV.type}">${evoV.type==='up'?'‚Üó':evoV.type==='down'?'‚Üò':'‚Üí'} ${evoV.text}</span></div>`;
  html += `<hr style="margin: 15px 0;">`;
  for(const v in d){ const actuel=d[v].ca; const precedent=dPrec[v]?.ca||0; const ev=calculerTendance(actuel,precedent); html += `<div class="metric"><span>${v}</span><span class="evolution-indicator evolution-${ev.type}">${ev.type==='up'?'‚Üó':ev.type==='down'?'‚Üò':'‚Üí'} ${ev.text}</span></div>`; }
  container.innerHTML = html;
}
function updatePerformance(){
  const container = document.getElementById('performance-content');
  const d = getDonneesActuelles(); let html='';
  for(const v in d){ const x=d[v]; const prog=x.objectif>0?(x.ca/x.objectif*100):0; const status=prog>=100?'positive':prog>=75?'neutral':'negative'; const icon=prog>=100?'üéØ':prog>=75?'üìà':'‚ö†Ô∏è'; html += `<div class="metric"><span>${icon} ${v}</span><span class="metric-value ${status}">${prog.toFixed(1)}%</span></div>`; }
  container.innerHTML = html;
}
function updateChartEvolution(){
  const chart = document.getElementById('chart-evolution'); let html='';
  const moisData=[]; for(let i=5;i>=0;i--){ let m=moisActuel-i; let a=anneeActuelle; if(m<0){ m+=12; a--; } const key=`${a}-${m}`; const d=donneesParMois[key]||{}; let totalCA=0; for(const v in d){ totalCA+=d[v]?.ca||0; } moisData.push({ mois: MOIS_NOMS[m].substring(0,3), ca: totalCA, isActuel: m===moisActuel && a===anneeActuelle }); }
  const maxCA = Math.max(...moisData.map(m=>m.ca));
  moisData.forEach(({mois,ca,isActuel})=>{ const h=maxCA>0?Math.max(30,(ca/maxCA)*160):30; html += `<div class="bar-group"><div class="bar" style="height:${h}px; background:${isActuel?'linear-gradient(to top,#667eea,#764ba2)':'linear-gradient(to top,#48bb78,#38a169)'}; ${isActuel?'box-shadow:0 4px 20px rgba(102,126,234,0.4);':''}"><div class="bar-value">${(ca/1000).toFixed(0)}k‚Ç¨</div></div><div class="bar-label" style="font-weight:${isActuel?'bold':'normal'}">${mois}</div></div>`; });
  chart.innerHTML = html;
}

function updateVueAnnuelle(){
  const el1 = document.getElementById('annee-actuelle-1');
  const el2 = document.getElementById('annee-actuelle-2');
  if (el1) el1.textContent = anneeActuelle;
  if (el2) el2.textContent = anneeActuelle;
}

function somme(obj, fn){ let s=0; for(const v in obj){ s += fn(obj[v]); } return s; }
function moyenne(a,b){ return b>0 ? a/b : 0; }

function forecastCA(){
  const points=[]; for(let i=3;i>=1;i--){ let m=moisActuel-i; let a=anneeActuelle; if(m<0){ m+=12; a--; }
    const key=`${a}-${m}`; const d=donneesParMois[key]||{}; points.push(somme(d, x=>x.ca)); }
  const avg3 = points.length? points.reduce((a,b)=>a+b,0)/points.length : 0;
  const courant = somme(getDonneesActuelles(), x=>x.ca);
  return Math.round(0.6*avg3 + 0.4*courant);
}

function forecastVentes(){
  const d = getDonneesActuelles(); const ventes = somme(d, x=>x.ventes); const prospects = somme(d, x=>x.prospects);
  const tauxActuel = moyenne(ventes, prospects);
  const cible = Math.max(tauxActuel, 0.22);
  const ventesPrev = Math.round(Math.max(ventes, prospects * cible));
  return { ventesPrev, tauxPrev: cible*100 };
}

function buildSuggestions(){
  const d = getDonneesActuelles();
  const suggestions=[];
  for(const v in d){ const x=d[v]; const taux = x.prospects>0?(x.ventes/x.prospects):0; const tauxPct=(taux*100).toFixed(1);
    const avgPanier = x.ventes>0 ? (x.ca/x.ventes) : 4000;
    const manqueCA = Math.max(0, x.objectif - x.ca);
    const ventesNec = Math.ceil(manqueCA / Math.max(1, avgPanier));
    const convCible = 0.25;
    const rdvSupp = Math.max(0, Math.ceil(ventesNec/Math.max(convCible, taux || 0.18)));
    const items = [];
    if(taux < 0.2) items.push(`Coaching pitch & traitement objections (taux actuel ${tauxPct}%)`);
    if(x.prospects < 40) items.push(`Ajouter ~${Math.max(10, rdvSupp)} RDV qualifi√©s (ciblage comptes √† forte propension)`);
    if(manqueCA > 0) items.push(`Upsell/Cross-sell: viser panier moyen ‚â• ${(avgPanier*1.1).toFixed(0)} ‚Ç¨ pour rattraper ${manqueCA.toLocaleString()} ‚Ç¨`);
    if(x.ventes>0 && avgPanier<5000) items.push(`Revoir politique de remise et bundles pour relever le panier moyen`);
    if(items.length===0) items.push('Rien d‚Äôurgent ‚Äî maintenir cadence et relances √† J+2/J+7');
    suggestions.push({ v, items });
  }
  return suggestions;
}

function updateIATab(){
  const seuil = parseInt(document.getElementById('seuil-marge').value)||2000;
  document.getElementById('label-seuil-marge').textContent = seuil.toLocaleString();

  const prevCA = forecastCA();
  const { ventesPrev, tauxPrev } = forecastVentes();
  document.getElementById('ia-prev-ca').textContent = prevCA.toLocaleString()+' ‚Ç¨';
  document.getElementById('ia-prev-ventes').textContent = ventesPrev.toString();
  document.getElementById('ia-prev-taux').textContent = tauxPrev.toFixed(1)+'%';

  const moisPrec = moisActuel===0?11:moisActuel-1; const anPrec = moisActuel===0?anneeActuelle-1:anneeActuelle; const dPrec = donneesParMois[`${anPrec}-${moisPrec}`]||{};
  const caPrec = somme(dPrec, x=>x.ca); const ventesPrec = somme(dPrec, x=>x.ventes);
  const tCA = calculerTendance(prevCA, caPrec); const tV = calculerTendance(ventesPrev, ventesPrec);
  document.getElementById('ia-prev-trend').innerHTML = `<span class="evolution-indicator evolution-${tCA.type}">${tCA.type==='up'?'‚Üó':'‚Üò'} ${tCA.text}</span>`;
  document.getElementById('ia-prev-ventes-trend').innerHTML = `<span class="evolution-indicator evolution-${tV.type}">${tV.type==='up'?'‚Üó':'‚Üò'} ${tV.text}</span>`;

  const sug = buildSuggestions();
  const sugEl = document.getElementById('ia-suggestions');
  let html='';
  sug.forEach(({v,items})=>{
    html += `<div class="stats-card" style="margin-bottom:10px;"><h4>üë§ ${v}</h4>${items.map(i=>`<div class=\\"metric\\"><span>‚úÖ</span><span class=\\"metric-value neutral\\" style=\\"font-weight:500;\\">${i}</span></div>`).join('')}</div>`;
  });
  sugEl.innerHTML = html;

  const d = getDonneesActuelles(); const body = document.getElementById('ia-marges'); body.innerHTML='';
  let nbSousSeuil=0;
  for(const v in d){ const x=d[v]; const margeU = x.margeValeur ?? 2500; const margeTot = Math.round((x.ventes||0) * margeU); const ok = margeU >= seuil; if(!ok) nbSousSeuil++;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${v}</td>
      <td>${x.ventes}</td>
      <td>${x.ca.toLocaleString()} ‚Ç¨</td>
      <td>${margeU.toLocaleString()} ‚Ç¨ / vente</td>
      <td>${margeTot.toLocaleString()} ‚Ç¨</td>
      <td class="${ok?'positive':'negative'}">${ok?'OK ‚úÖ':`<strong>‚ö†Ô∏è Sous ${seuil.toLocaleString()} ‚Ç¨</strong>`}</td>`;
    body.appendChild(tr);
  }
  document.getElementById('ia-messages').innerHTML = nbSousSeuil===0
    ? `<div class="alert alert-success"><strong>üëç Parfait :</strong> toutes les marges/vente sont ‚â• ${seuil.toLocaleString()} ‚Ç¨.</div>`
    : `<div class="alert alert-warning"><strong>Attention :</strong> ${nbSousSeuil} vendeur(s) sous le seuil. Ajuster prix/remises, mix produit ou qualification.</div>`;

  const chart = document.getElementById('ia-chart-prev'); let bars='';
  const moisData=[]; for(let i=5;i>=1;i--){ let m=moisActuel-i; let a=anneeActuelle; if(m<0){ m+=12; a--; } const key=`${a}-${m}`; const dM=donneesParMois[key]||{}; moisData.push({ label: MOIS_NOMS[m].substring(0,3), ca: somme(dM, x=>x.ca), current:false }); }
  moisData.push({ label: MOIS_NOMS[moisActuel].substring(0,3), ca: prevCA, current:true });
  const maxCA=Math.max(...moisData.map(m=>m.ca),1);
  moisData.forEach(({label,ca,current})=>{ const h = Math.max(30,(ca/maxCA)*160); bars += `<div class=\\"bar-group\\"><div class=\\"bar\\\" style=\\"height:${h}px; background:${current?'linear-gradient(to top,#667eea,#764ba2)':'linear-gradient(to top,#48bb78,#38a169)'};\\"><div class=\\"bar-value\\">${(ca/1000).toFixed(0)}k‚Ç¨</div></div><div class=\\"bar-label\\" style=\\"font-weight:${current?'bold':'normal'}\\">${label}</div></div>`; });
  chart.innerHTML = bars;
}

function updateSaisieFields(){
  const sel = document.getElementById('vendeur-select');
  const v = sel.value;
  const d = getDonneesActuelles();
  const marge = d[v]?.margeValeur ?? 2500;
  const objectif = d[v]?.objectif ?? 80000;
  document.getElementById('marge-input').value = marge;
  document.getElementById('objectif-input').value = objectif;
}

function sauvegarderDonnees(){
  const v=document.getElementById('vendeur-select').value;
  const prospects=parseInt(document.getElementById('prospects-input').value)||0;
  const ventes=parseInt(document.getElementById('ventes-input').value)||0;
  const ca=parseInt(document.getElementById('ca-input').value)||0;
  const margeInput=document.getElementById('marge-input').value;
  const objectifInput=document.getElementById('objectif-input').value;
  const margeU = margeInput !== '' ? Math.max(0, parseFloat(margeInput)) : null;
  const objectif = objectifInput !== '' ? Math.max(0, parseFloat(objectifInput)) : null;

  if(prospects===0 && ventes===0 && ca===0 && margeU===null && objectif===null){
    showNotification('Veuillez saisir au moins une valeur','warning'); return;
  }
  if(ventes>prospects && prospects>0){
    showNotification('Erreur : les ventes ne peuvent pas d√©passer les prospects','warning'); return;
  }
  const d=getDonneesActuelles();
  d[v].prospects+=prospects;
  d[v].ventes+=ventes;
  d[v].ca+=ca;
  if(margeU!==null) d[v].margeValeur = margeU;
  if(objectif!==null) d[v].objectif = objectif;

  document.getElementById('prospects-input').value='';
  document.getElementById('ventes-input').value='';
  document.getElementById('ca-input').value='';

  showNotification(`Donn√©es sauvegard√©es pour ${v} (${MOIS_NOMS[moisActuel]})`);
  const activeTab=document.querySelector('.tab.active'); if(activeTab){ const tabName = activeTab.getAttribute('onclick').match(/'(.*?)'/)[1]; updateTabContent(tabName); }
}

function exporterDonnees(){
  const dataToExport={ donneesParMois, moisActuel, anneeActuelle, dateExport:new Date().toISOString(), version:'vercel-blob-1' };
  const blob=new Blob([JSON.stringify(dataToExport,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`dashboard-commercial-${anneeActuelle}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
  showNotification('Donn√©es export√©es avec succ√®s !');
}

function reinitialiserMois(){
  if(confirm(`√ätes-vous s√ªr de vouloir r√©initialiser les donn√©es de ${MOIS_NOMS[moisActuel]} ${anneeActuelle} ?`)){
    const key=getMoisKey(); donneesParMois[key]= vendeurDefaults();
    updateTabContent('vue-ensemble'); showNotification(`Donn√©es de ${MOIS_NOMS[moisActuel]} r√©initialis√©es`,'warning');
  }
}
function reinitialiserTout(){
  if(confirm('‚ö†Ô∏è ATTENTION : Cette action supprimera TOUTES les donn√©es de TOUS les mois. √ätes-vous absolument certain ?')){
    donneesParMois={}; initialiserDonnees(); updateTabContent('vue-ensemble'); showNotification('Toutes les donn√©es ont √©t√© supprim√©es','warning');
  }
}
function genererDonneesDemonstration(){
  if(confirm('G√©n√©rer des donn√©es de d√©monstration pour les 6 derniers mois ?')){
    for(let i=5;i>=0;i--){ let m=moisActuel-i; let a=anneeActuelle; if(m<0){ m+=12; a--; } const key=`${a}-${m}`; const f=0.7+Math.random()*0.6;
      donneesParMois[key]={
        'Vincent':{prospects:Math.floor(50*f), ventes:Math.floor(12*f), ca:Math.floor(45000*f), objectif:80000, margeValeur: 1800 + Math.round(Math.random()*1200)},
        'Raphael':{prospects:Math.floor(60*f), ventes:Math.floor(18*f), ca:Math.floor(75000*f), objectif:100000, margeValeur: 2000 + Math.round(Math.random()*1400)},
        'L√©o':{prospects:Math.floor(45*f), ventes:Math.floor(10*f), ca:Math.floor(35000*f), objectif:75000, margeValeur: 1500 + Math.round(Math.random()*1200)},
        'Pablo':{prospects:Math.floor(55*f), ventes:Math.floor(15*f), ca:Math.floor(60000*f), objectif:90000, margeValeur: 1700 + Math.round(Math.random()*1300)},
        'Nathan':{prospects:Math.floor(48*f), ventes:Math.floor(13*f), ca:Math.floor(52000*f), objectif:85000, margeValeur: 1600 + Math.round(Math.random()*1400)}
      };
    }
    updateTabContent('vue-ensemble'); showNotification('Donn√©es de d√©monstration g√©n√©r√©es !');
  }
}

async function chargerDepuisServeur() {
  document.getElementById('server-status').textContent = 'Chargement...';
  const res = await fetch('/api/data', { method: 'GET' });
  const data = await res.json();
  if (data && data.donneesParMois) {
    donneesParMois = data.donneesParMois;
    const keys = Object.keys(donneesParMois).sort();
    if (keys.length) {
      const last = keys[keys.length - 1];
      const [a, m] = last.split('-').map(Number);
      anneeActuelle = a; moisActuel = m;
    }
    updateMoisAffichage(); updateVueEnsemble(); updateSaisieFields();
    showNotification('Donn√©es charg√©es depuis le serveur ‚úÖ');
    document.getElementById('server-status').textContent = 'Dernier chargement r√©ussi.';
  } else {
    showNotification('Serveur initialis√©. Aucune donn√©e encore.', 'warning');
    document.getElementById('server-status').textContent = 'Serveur initialis√© (pas de donn√©es).';
  }
}

async function sauvegarderVersServeur() {
  document.getElementById('server-status').textContent = 'Sauvegarde en cours...';
  const payload = {
    donneesParMois,
    moisActuel,
    anneeActuelle,
    dateExport: new Date().toISOString(),
    version: 'vercel-blob-1'
  };
  const res = await fetch('/api/data', {
    method: 'POST',
    headers: { 'content-type': 'application/json' },
    body: JSON.stringify(payload)
  });
  if (res.ok) {
    showNotification('Donn√©es sauvegard√©es sur le serveur ‚úÖ');
    document.getElementById('server-status').textContent = 'Derni√®re sauvegarde r√©ussie.';
  } else {
    showNotification('Erreur de sauvegarde serveur', 'warning');
    document.getElementById('server-status').textContent = 'Erreur de sauvegarde.';
  }
}

document.addEventListener('DOMContentLoaded', function(){
  initialiserDonnees(); updateMoisAffichage(); updateVueEnsemble(); updateSaisieFields(); showNotification('Dashboard Pro charg√© ! üöÄ');
});
</script>
</body>
</html>
